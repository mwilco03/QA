!function(){"use strict";const e={baseUrl:"",DELIMITER_CHOICE:"[,]",DELIMITER_MATCH:"[.]",DELIMITER_CASE:"{case_matters=",types:{CHOICE:"CHOICE",FILL_IN:"FILL_IN",LONG_FILL_IN:"LONG_FILL_IN",MATCHING:"MATCHING",SEQUENCING:"SEQUENCING",TRUE_FALSE:"TRUE_FALSE"}};function t(t){return t?t.split(e.DELIMITER_CHOICE).map(e=>e.trim()).filter(Boolean):[]}function s(t){if(!t)return{answers:[],caseMatters:!1};let s=!1,o=t;if(t.startsWith(e.DELIMITER_CASE)){const r=t.indexOf("}");-1!==r&&(s="true"===t.substring(e.DELIMITER_CASE.length,r),o=t.substring(r+1))}return{answers:o.split(e.DELIMITER_CHOICE).map(e=>e.trim()).filter(Boolean),caseMatters:s}}function o(t){return t?t.split(e.DELIMITER_CHOICE).map(t=>{const[s,o]=t.split(e.DELIMITER_MATCH);return{source:s?.trim(),target:o?.trim()}}).filter(e=>e.source&&e.target):[]}function r(t){return t?t.split(e.DELIMITER_CHOICE).map((e,t)=>({position:t+1,item:e.trim()})).filter(e=>e.item):[]}function n(e){return e?"true"===e.toLowerCase().trim():null}function a(a,c){switch(c?.toUpperCase()){case e.types.CHOICE:return{type:"choice",correct:t(a)};case e.types.FILL_IN:case e.types.LONG_FILL_IN:return{type:"fill_in",...s(a)};case e.types.MATCHING:return{type:"matching",pairs:o(a)};case e.types.SEQUENCING:return{type:"sequencing",sequence:r(a)};case e.types.TRUE_FALSE:return{type:"true_false",correct:n(a)};default:return a?.includes(e.DELIMITER_MATCH)?{type:"matching",pairs:o(a)}:a?.startsWith(e.DELIMITER_CASE)?{type:"fill_in",...s(a)}:{type:"choice",correct:t(a)}}}async function c(t,s={}){const o=e.baseUrl+t,r=await fetch(o,{headers:{"Content-Type":"application/json",...s.headers},...s});if(!r.ok)throw new Error(`API Error: ${r.status} ${r.statusText}`);return r.json().catch(()=>null)}async function i(e){return c(`/api/assets/tasks.json?contentUrl=${encodeURIComponent(e)}`)}async function l(e){return c(`/api/sessions/${e}/lrs/state`)}async function p(e,t){return c(`/api/sessions/${e}/lrs/state`,{method:"PUT",body:JSON.stringify(t)})}async function u(e){return c(`/api/sessions/${e}/score`,{method:"POST"})}function d(e){const t=e.parsedCorrect||a(e.correctPattern,e.type);switch(t.type){case"choice":return t.correct;case"fill_in":return t.answers[0]||"";case"matching":return t.pairs.map(e=>`${e.source}[.]${e.target}`).join("[,]");case"sequencing":return t.sequence.map(e=>e.item).join("[,]");case"true_false":return String(t.correct);default:return e.correctPattern}}function T(e){const t={answers:{},viewedTasks:[],viewedTaskGroups:[],completedTasks:[],completedTaskGroups:[],questionResults:{},taskProgress:{},taskGroupProgress:{}};if(!e?.taskGroups)return t;for(const s of e.taskGroups){const e=s.id||s.slug;t.viewedTaskGroups.push(e);let o=0,r=0;if(s.tasks){for(const e of s.tasks){const s=e.id||e.slug;t.viewedTasks.push(s);let n=0,c=0;if(e.questions&&0!==e.questions.length){for(const s of e.questions){const e=s.id;c++,r++;const i=d({...s,parsedCorrect:a(s.correctPattern,s.type)});t.answers[e]=i,t.questionResults[e]={answered:!0,correct:!0,response:i,attempts:1,timestamp:(new Date).toISOString()},n++,o++}t.completedTasks.push(s),t.taskProgress[s]={viewed:!0,completed:!0,progress:1,questionsAnswered:n,questionsTotal:c,score:c>0?n/c:1}}else t.completedTasks.push(s),t.taskProgress[s]={viewed:!0,completed:!0,progress:1,questionsAnswered:0,questionsTotal:0}}t.completedTaskGroups.push(e),t.taskGroupProgress[e]={viewed:!0,completed:!0,progress:1,tasksCompleted:s.tasks.length,tasksTotal:s.tasks.length,questionsCorrect:o,questionsTotal:r,score:r>0?o/r:1}}else t.completedTaskGroups.push(e),t.taskGroupProgress[e]={viewed:!0,completed:!0,progress:1}}return t}const TLAHelper={config:e,parseChoicePattern:t,parseFillInPattern:s,parseMatchingPattern:o,parseSequencingPattern:r,parseTrueFalsePattern:n,parseCorrectPattern:a,extractFromTasksJson:function(e){const t=[];if(!e?.taskGroups)return t;for(const s of e.taskGroups)if(s.tasks)for(const e of s.tasks)if(e.questions)for(const o of e.questions){const r=a(o.correctPattern,o.type);t.push({id:o.id,prompt:o.prompt,type:o.type,choices:o.choices||[],source:o.source||[],target:o.target||[],correctPattern:o.correctPattern,parsedCorrect:r,taskId:e.id,taskTitle:e.title,groupId:s.id,groupTitle:s.title})}return t},setBaseUrl(t){e.baseUrl=t.replace(/\/$/,"")},getTasks:i,getLrsState:l,setLrsState:p,submitScore:u,getSession:async function(e){return c(`/api/sessions/${e}`,{cache:"no-store"})},createSession:async function(e,t=null,s=!1){return c("/api/sessions",{method:"POST",body:JSON.stringify({contentUrl:e,cmi5LaunchParameters:t,dryRun:s})})},generateCorrectResponse:d,buildCorrectLrsState:function(e){const t={};for(const s of e)t[s.id]=d(s);return{answers:t}},buildFullCompletionState:T,async autoComplete(e,t){console.log("[TLAHelper] ═══════════════════════════════════════════════════"),console.log("[TLAHelper] Starting FULL auto-complete with iteration..."),console.log("[TLAHelper] ═══════════════════════════════════════════════════");const s=await i(t);if(!s)throw new Error("Failed to fetch tasks.json");let o=0,r=0,n=0;if(s.taskGroups)for(const e of s.taskGroups)if(o++,e.tasks)for(const t of e.tasks)r++,t.questions&&(n+=t.questions.length);console.log(`[TLAHelper] Found: ${o} groups, ${r} tasks, ${n} questions`);const a=T(s);console.log("[TLAHelper] Built full completion state:"),console.log(`  - Task Groups viewed/completed: ${a.viewedTaskGroups.length}/${a.completedTaskGroups.length}`),console.log(`  - Tasks viewed/completed: ${a.viewedTasks.length}/${a.completedTasks.length}`),console.log(`  - Questions answered: ${Object.keys(a.answers).length}`);let c={};try{c=await l(e)||{}}catch(e){console.log("[TLAHelper] No existing state, starting fresh")}const d={...c,...a,answers:{...c.answers,...a.answers},viewedTasks:[...new Set([...c.viewedTasks||[],...a.viewedTasks])],viewedTaskGroups:[...new Set([...c.viewedTaskGroups||[],...a.viewedTaskGroups])],completedTasks:[...new Set([...c.completedTasks||[],...a.completedTasks])],completedTaskGroups:[...new Set([...c.completedTaskGroups||[],...a.completedTaskGroups])],questionResults:{...c.questionResults,...a.questionResults}};console.log("[TLAHelper] Updating LRS state with all items marked complete..."),await p(e,d),console.log("[TLAHelper] ✓ LRS state updated"),console.log("[TLAHelper] Submitting score...");const f=await u(e);return console.log("[TLAHelper] ✓ Score submitted:",f),console.log("[TLAHelper] ═══════════════════════════════════════════════════"),console.log("[TLAHelper] AUTO-COMPLETE FINISHED"),console.log("[TLAHelper] ═══════════════════════════════════════════════════"),{tasks:s,fullState:d,result:f,summary:{taskGroups:o,tasks:r,questions:n,allCompleted:!0}}},async iterateAndComplete(e,t,s={}){const{delay:o=100,onProgress:r=null}=s;console.log("[TLAHelper] Starting iterative completion...");const n=await i(t);if(!n?.taskGroups)throw new Error("No task groups found");let c=await l(e)||{},T=0,f=0;for(const e of n.taskGroups){f++;for(const t of e.tasks||[])f++,f+=(t.questions||[]).length}for(const t of n.taskGroups){const s=t.id||t.slug;c.viewedTaskGroups=c.viewedTaskGroups||[],c.viewedTaskGroups.includes(s)||c.viewedTaskGroups.push(s);for(const s of t.tasks||[]){const t=s.id||s.slug;c.viewedTasks=c.viewedTasks||[],c.viewedTasks.includes(t)||c.viewedTasks.push(t);for(const e of s.questions||[]){const t=e.id;c.answers=c.answers||{},c.answers[t]=d({...e,parsedCorrect:a(e.correctPattern,e.type)}),c.questionResults=c.questionResults||{},c.questionResults[t]={answered:!0,correct:!0,response:c.answers[t],attempts:1},T++,r&&r({completed:T,total:f,current:t,type:"question"}),o>0&&await new Promise(e=>setTimeout(e,o))}c.completedTasks=c.completedTasks||[],c.completedTasks.includes(t)||c.completedTasks.push(t),T++,r&&r({completed:T,total:f,current:t,type:"task"}),await p(e,c)}c.completedTaskGroups=c.completedTaskGroups||[],c.completedTaskGroups.includes(s)||c.completedTaskGroups.push(s),T++,r&&r({completed:T,total:f,current:s,type:"group"}),await p(e,c)}const m=await u(e);return console.log(`[TLAHelper] Iterative completion done: ${T}/${f} items`),{state:c,result:m,completed:T,total:f}},exportQuestions(e,t="json"){switch(t){case"text":{let t="=== TLA QUESTIONS & ANSWERS ===\n\n";return e.forEach((e,s)=>{t+=`--- Q${s+1}: ${e.prompt||"No prompt"} ---\n`,t+=`Type: ${e.type}\n`,t+=`Correct Pattern: ${e.correctPattern}\n`;const o=e.parsedCorrect||a(e.correctPattern,e.type);"sequencing"===o.type?(t+="Correct Sequence:\n",o.sequence.forEach(e=>{t+=`  ${e.position}. ${e.item}\n`})):"matching"===o.type?(t+="Correct Matches:\n",o.pairs.forEach(e=>{t+=`  ${e.source} → ${e.target}\n`})):"fill_in"===o.type?(t+=`Correct Answers: ${o.answers.join(", ")}\n`,t+=`Case Sensitive: ${o.caseMatters}\n`):t+=`Correct: ${JSON.stringify(o.correct)}\n`,t+="\n"}),t}case"csv":{let t="ID,Prompt,Type,CorrectPattern,ParsedAnswer\n";return e.forEach(e=>{const s=(e.prompt||"").replace(/"/g,'""'),o=d(e).replace(/"/g,'""');t+=`"${e.id}","${s}","${e.type}","${e.correctPattern}","${o}"\n`}),t}default:return JSON.stringify(e,null,2)}}};"undefined"!=typeof window&&(window.TLAHelper=TLAHelper,console.log("[TLAHelper] Loaded. Use TLAHelper.autoComplete(sessionId, contentUrl) for auto-completion")),"undefined"!=typeof module&&module.exports&&(module.exports=TLAHelper)}("undefined"!=typeof window?window:global);