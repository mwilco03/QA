#!/usr/bin/env node
!function(){"use strict";function e(e){const t=e.match(/globalProvideData\s*\(\s*['"]data['"]\s*,\s*'(.+)'\s*\)/s);if(!t)throw new Error("Could not find globalProvideData in _data.js");let n=t[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r");return JSON.parse(n)}function t(e){return e?e.replace(/<[^>]*>/g,"").replace(/\\n/g," ").replace(/\s+/g," ").trim():""}function n(e){return e?.[0]?.vartext?.blocks?e[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join("").trim():""}function s(e,t,n){e&&function e(s){if(s&&"object"==typeof s){if("comparison"===s.kind||"comparison"===s.type){const e=s.left||s.lhs,r=s.right||s.rhs;if(e&&r){let s=null,c=null;if("string"==typeof e&&e.includes("choice_")&&(s=e.match(/choice_[A-Za-z0-9]+/)?.[0]),"string"==typeof r&&r.includes("choice_")&&(s=r.match(/choice_[A-Za-z0-9]+/)?.[0]),"string"==typeof e&&e.includes("statement_")){const t=e.match(/statement_[A-Za-z0-9]+/)?.[0];c=o(t,n)}if("string"==typeof r&&r.includes("statement_")){const e=r.match(/statement_[A-Za-z0-9]+/)?.[0];c=o(e,n)}"number"==typeof e&&(c=e),"number"==typeof r&&(c=r),"string"==typeof e&&/^\d+$/.test(e)&&(c=parseInt(e,10)),"string"==typeof r&&/^\d+$/.test(r)&&(c=parseInt(r,10)),s&&c&&t.set(s,c)}}for(const t in s)Array.isArray(s[t])?s[t].forEach(t=>e(t)):"object"==typeof s[t]&&e(s[t])}}(e)}function o(e,t){if(!t.statements||!e)return null;const n=t.statements.find(t=>t.id===e);return n?.position?parseInt(n.position,10):null}function r(e){const n=[];if(!e.scenes)return console.warn("No scenes found in data"),n;for(const s of e.scenes)if(s.slides)for(const e of s.slides){const s=t(e.title||"");if(e.interactions||e.slideLayers){if(e.interactions)for(const t of e.interactions){const o=c(t,s,e.id);o&&n.push(o)}if(e.slideLayers)for(const t of e.slideLayers)if(t.objects)for(const o of t.objects)if("sequencectrl"===o.kind||o.interactions){const t=i(o,s,e.id);t&&n.push(t)}}}return n}function c(e,o,r){const c=function(e){const t=e.type?.toLowerCase()||"",n=e.statements&&e.statements.length>0,s=e.choices&&e.choices.length>0;return t.includes("sequence")||t.includes("order")?"sequence":t.includes("drag")||t.includes("drop")?"drag-drop":t.includes("match")?"matching":t.includes("hotspot")?"hotspot":t.includes("text")||t.includes("fill")?"fill-in":n&&s?"sequence":e.multiSelect?"multiple-select":"multiple-choice"}(e),i="sequence"===c||"drag-drop"===c,a=i?function(e){const t=new Map;if(e.answers)for(const n of e.answers)"correct"===n.status&&n.eval&&s(n.eval,t,e);if(e.choices&&e.statements)for(const n of e.choices){const s=n.id,o=s.replace(/^choice_/,""),r=e.statements.find(e=>e.id?.includes(o));r&&r.position&&t.set(s,parseInt(r.position,10))}if(e.answers)for(const n of e.answers)n.correctResponse&&Array.isArray(n.correctResponse)&&n.correctResponse.forEach((e,n)=>{t.set(e,n+1)});return t}(e):new Map,l=[];if(e.choices)for(const s of e.choices){const e=t(s.text||s.label||n(s.textLib));if(!e)continue;const o={id:s.id,text:e,correct:!1,sequence:null};i&&a.has(s.id)&&(o.sequence=a.get(s.id),o.correct=!0),i||(o.correct=!0===s.correct||!0===s.isCorrect||"correct"===s.status),l.push(o)}if(i&&l.sort((e,t)=>(e.sequence||999)-(t.sequence||999)),e.answers&&!i)for(const t of e.answers)if("correct"===t.status&&t.choiceId){const e=l.find(e=>e.id===t.choiceId);e&&(e.correct=!0)}return 0===l.length?null:{slideId:r,questionId:e.id,question:o||e.prompt||e.question||"",questionType:c,answers:l,correctSequence:i?l.filter(e=>e.sequence).map(e=>({position:e.sequence,text:e.text})).sort((e,t)=>e.position-t.position):null,source:"storyline-data"}}function i(e,s,o){if("sequencectrl"===e.kind&&e.data?.itemlist){const r=[];for(let s=0;s<e.data.itemlist.length;s++){const o=e.data.itemlist[s],c=t(o.textdata?.altText||o.textdata?.lmstext||n(o.textLib));c&&r.push({id:o.itemdata||`item_${s}`,text:c,correct:!0,sequence:s+1})}return 0===r.length?null:{slideId:o,questionId:e.id,question:s,questionType:"sequence",answers:r,correctSequence:r.map(e=>({position:e.sequence,text:e.text})),source:"storyline-data"}}return null}const StorylineExtractor={extractFromDataJS:t=>r(e(t)),extractFromJSON:e=>r(e),search:(e,t)=>function(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(e=>e.question?.toLowerCase().includes(n)||e.slideId?.toLowerCase().includes(n)||e.answers?.some(e=>e.text?.toLowerCase().includes(n)))}(e,t),format:(e,t="json")=>function(e,t="json"){switch(t){case"json":default:return JSON.stringify(e,null,2);case"text":{let t="=== STORYLINE Q&A EXTRACTION ===\n";return t+=`Total Questions: ${e.length}\n\n`,e.forEach((e,n)=>{t+=`━━━ Question ${n+1} [${e.slideId||"N/A"}] ━━━\n`,t+=`Type: ${e.questionType}\n`,e.question&&(t+=`Q: ${e.question}\n`),"sequence"===e.questionType&&e.correctSequence?(t+="\nCorrect Sequence:\n",e.correctSequence.forEach(e=>{t+=`  ${e.position}. ${e.text}\n`})):(t+="\nAnswers:\n",e.answers.forEach((e,n)=>{const s=e.correct?"[✓]":"[ ]",o=e.sequence?` (pos: ${e.sequence})`:"";t+=`  ${n+1}. ${s} ${e.text}${o}\n`})),t+="\n"}),t}case"csv":{let t="SlideID,Question,QuestionType,Answer,Correct,Sequence\n";return e.forEach(e=>{e.answers.forEach(n=>{const s=(e.question||"").replace(/"/g,'""'),o=(n.text||"").replace(/"/g,'""');t+=`"${e.slideId}","${s}","${e.questionType}","${o}",${n.correct},${n.sequence||""}\n`})}),t}}}(e,t),getSequenceQuestions:e=>e.filter(e=>"sequence"===e.questionType||"drag-drop"===e.questionType),getCorrectAnswers:e=>e.map(e=>"sequence"===e.questionType&&e.correctSequence?{slideId:e.slideId,question:e.question,type:e.questionType,correctAnswer:e.correctSequence.map(e=>`${e.position}. ${e.text}`).join(" → ")}:{slideId:e.slideId,question:e.question,type:e.questionType,correctAnswer:e.answers.filter(e=>e.correct).map(e=>e.text).join(", ")}),parseDataJS:e,cleanText:t};if("undefined"!=typeof require&&require.main===module){const e=require("fs"),t=require("path"),n=process.argv.slice(2);0===n.length&&(console.log("Usage: node storyline-data-extractor.js <path-to-_data.js> [search-term] [--format=json|text|csv]"),console.log("\nExamples:"),console.log("  node storyline-data-extractor.js _data.js"),console.log('  node storyline-data-extractor.js _data.js "ASOM"'),console.log('  node storyline-data-extractor.js _data.js "HAS-1.2.3"'),console.log("  node storyline-data-extractor.js _data.js --format=text"),process.exit(1));const s=n[0];let o=null,r="json";for(let e=1;e<n.length;e++)n[e].startsWith("--format=")?r=n[e].split("=")[1]:o=n[e];try{const n=e.readFileSync(s,"utf-8");let c=StorylineExtractor.extractFromDataJS(n);console.error(`[INFO] Extracted ${c.length} questions`),o&&(c=StorylineExtractor.search(c,o),console.error(`[INFO] Found ${c.length} matching "${o}"`));const i=StorylineExtractor.format(c,r);console.log(i);const a=t.basename(s,".js")+"_questions."+("csv"===r?"csv":"text"===r?"txt":"json");e.writeFileSync(a,i),console.error(`[INFO] Written to ${a}`)}catch(e){console.error(`[ERROR] ${e.message}`),process.exit(1)}}"undefined"!=typeof window&&(window.StorylineExtractor=StorylineExtractor,console.log("[StorylineExtractor] Loaded. Use StorylineExtractor.extractFromDataJS(content)")),"undefined"!=typeof module&&module.exports&&(module.exports=StorylineExtractor)}("undefined"!=typeof window?window:global);