#!/usr/bin/env node
!function(){"use strict";function e(){const e=[];return document.querySelectorAll("script[src]").forEach(t=>{const n=t.src;n&&(n.includes("/html5/")||n.includes("/data/js/")||n.includes("storyline")||n.includes("player"))&&e.push(n)}),"undefined"!=typeof performance&&performance.getEntriesByType&&performance.getEntriesByType("resource").forEach(t=>{("script"===t.initiatorType||t.name.endsWith(".js"))&&(t.name.includes("/html5/")||t.name.includes("/data/js/")||t.name.includes("storyline"))&&e.push(t.name)}),[...new Set(e)]}function t(){const t=e();for(const e of t){const t=e.match(/(.+?)\/html5\/data\/js\//);if(t)return t[1];const n=e.match(/(.+?)\/html5\//);if(n)return n[1]}const n=document.querySelectorAll("iframe");for(const e of n)try{const t=e.src||"";if(t.includes("/story_html5.html")||t.includes("/story.html"))return t.replace(/\/(?:story_html5|story)\.html.*$/,"");if(t.includes("/html5/")){const e=t.match(/(.+?)\/html5\//);if(e)return e[1]}}catch(e){}const o=window.location.href;if(o.includes("/html5/")){const e=o.match(/(.+?)\/html5\//);if(e)return e[1]}return o.includes("/story")?o.replace(/\/story.*$/,""):window.DS||window.globalProvideData?window.location.href.replace(/\/[^/]*$/,""):null}async function n(e,t=5e3){const n=new AbortController,o=setTimeout(()=>n.abort(),t);try{const t=await fetch(e,{signal:n.signal});return clearTimeout(o),t.ok?await t.text():null}catch(e){return clearTimeout(o),null}}async function o(e){const t=`${e}/html5/data/js`,o=["data.js","frame.js","paths.js","text.js","textdata.js"],s=[];for(const e of o){const o=await n(`${t}/${e}`);o&&o.includes("globalProvideData")&&s.push({file:e,content:o,url:`${t}/${e}`})}return s}function s(e){const t=e.match(/globalProvideData\s*\(\s*['"]data['"]\s*,\s*'(.+)'\s*\)/s);if(!t)throw new Error("Could not find globalProvideData in content");let n=t[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r");return JSON.parse(n)}function r(e){return e?e.replace(/<[^>]*>/g,"").replace(/\\n/g," ").replace(/\s+/g," ").trim():""}function c(e){return e?.[0]?.vartext?.blocks?e[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join("").trim():""}function i(e,t,n){e&&function e(o){if(o&&"object"==typeof o){if("comparison"===o.kind||"comparison"===o.type){const e=o.left||o.lhs,s=o.right||o.rhs;if(e&&s){let o=null,r=null;if("string"==typeof e&&e.includes("choice_")&&(o=e.match(/choice_[A-Za-z0-9]+/)?.[0]),"string"==typeof s&&s.includes("choice_")&&(o=s.match(/choice_[A-Za-z0-9]+/)?.[0]),"string"==typeof e&&e.includes("statement_")){const t=e.match(/statement_[A-Za-z0-9]+/)?.[0];r=a(t,n)}if("string"==typeof s&&s.includes("statement_")){const e=s.match(/statement_[A-Za-z0-9]+/)?.[0];r=a(e,n)}"number"==typeof e&&(r=e),"number"==typeof s&&(r=s),"string"==typeof e&&/^\d+$/.test(e)&&(r=parseInt(e,10)),"string"==typeof s&&/^\d+$/.test(s)&&(r=parseInt(s,10)),o&&r&&t.set(o,r)}}for(const t in o)Array.isArray(o[t])?o[t].forEach(t=>e(t)):"object"==typeof o[t]&&e(o[t])}}(e)}function a(e,t){if(!t.statements||!e)return null;const n=t.statements.find(t=>t.id===e);return n?.position?parseInt(n.position,10):null}function l(e){const t=[];if(!e.scenes)return console.warn("No scenes found in data"),t;for(const n of e.scenes)if(n.slides)for(const e of n.slides){const n=r(e.title||"");if(e.interactions||e.slideLayers){if(e.interactions)for(const o of e.interactions){const s=u(o,n,e.id);s&&t.push(s)}if(e.slideLayers)for(const o of e.slideLayers)if(o.objects)for(const s of o.objects)if("sequencectrl"===s.kind||s.interactions){const o=d(s,n,e.id);o&&t.push(o)}}}return t}function u(e,t,n){const o=function(e){const t=e.type?.toLowerCase()||"",n=e.statements&&e.statements.length>0,o=e.choices&&e.choices.length>0;return t.includes("sequence")||t.includes("order")?"sequence":t.includes("drag")||t.includes("drop")?"drag-drop":t.includes("match")?"matching":t.includes("hotspot")?"hotspot":t.includes("text")||t.includes("fill")?"fill-in":n&&o?"sequence":e.multiSelect?"multiple-select":"multiple-choice"}(e),s="sequence"===o||"drag-drop"===o,a=s?function(e){const t=new Map;if(e.answers)for(const n of e.answers)"correct"===n.status&&n.eval&&i(n.eval,t,e);if(e.choices&&e.statements)for(const n of e.choices){const o=n.id,s=o.replace(/^choice_/,""),r=e.statements.find(e=>e.id?.includes(s));r&&r.position&&t.set(o,parseInt(r.position,10))}if(e.answers)for(const n of e.answers)n.correctResponse&&Array.isArray(n.correctResponse)&&n.correctResponse.forEach((e,n)=>{t.set(e,n+1)});return t}(e):new Map,l=[];if(e.choices)for(const t of e.choices){const e=r(t.text||t.label||c(t.textLib));if(!e)continue;const n={id:t.id,text:e,correct:!1,sequence:null};s&&a.has(t.id)&&(n.sequence=a.get(t.id),n.correct=!0),s||(n.correct=!0===t.correct||!0===t.isCorrect||"correct"===t.status),l.push(n)}if(s&&l.sort((e,t)=>(e.sequence||999)-(t.sequence||999)),e.answers&&!s)for(const t of e.answers)if("correct"===t.status&&t.choiceId){const e=l.find(e=>e.id===t.choiceId);e&&(e.correct=!0)}return 0===l.length?null:{slideId:n,questionId:e.id,question:t||e.prompt||e.question||"",questionType:o,answers:l,correctSequence:s?l.filter(e=>e.sequence).map(e=>({position:e.sequence,text:e.text})).sort((e,t)=>e.position-t.position):null,source:"storyline-data"}}function d(e,t,n){if("sequencectrl"===e.kind&&e.data?.itemlist){const o=[];for(let t=0;t<e.data.itemlist.length;t++){const n=e.data.itemlist[t],s=r(n.textdata?.altText||n.textdata?.lmstext||c(n.textLib));s&&o.push({id:n.itemdata||`item_${t}`,text:s,correct:!0,sequence:t+1})}return 0===o.length?null:{slideId:n,questionId:e.id,question:t,questionType:"sequence",answers:o,correctSequence:o.map(e=>({position:e.sequence,text:e.text})),source:"storyline-data"}}return null}const StorylineExtractor={async run(){if(console.log("[StorylineExtractor] Starting dynamic discovery..."),window.DS){console.log("[StorylineExtractor] Found window.DS");const e=l(window.DS);return window.allQA=e,console.log(`[StorylineExtractor] Extracted ${e.length} questions`),e}const e=t();if(!e)throw new Error("Could not detect Storyline base URL");console.log(`[StorylineExtractor] Base URL: ${e}`);const n=await o(e);console.log(`[StorylineExtractor] Found ${n.length} data files`);const r=[];for(const{file:e,content:t}of n)try{const n=l(s(t));console.log(`[StorylineExtractor] ${e}: ${n.length} questions`),r.push(...n)}catch(t){console.warn(`[StorylineExtractor] Failed to parse ${e}: ${t.message}`)}const c=new Set,i=r.filter(e=>{const t=`${e.slideId}:${e.questionId}`;return!c.has(t)&&(c.add(t),!0)});return window.allQA=i,console.log(`[StorylineExtractor] Total: ${i.length} unique questions`),i},extractFromDataJS:e=>l(s(e)),extractFromJSON:e=>l(e),search:(e,t)=>function(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(e=>e.question?.toLowerCase().includes(n)||e.slideId?.toLowerCase().includes(n)||e.answers?.some(e=>e.text?.toLowerCase().includes(n)))}(e,t),format:(e,t="json")=>function(e,t="json"){switch(t){case"json":default:return JSON.stringify(e,null,2);case"text":{let t="=== STORYLINE Q&A EXTRACTION ===\n";return t+=`Total Questions: ${e.length}\n\n`,e.forEach((e,n)=>{t+=`━━━ Question ${n+1} [${e.slideId||"N/A"}] ━━━\n`,t+=`Type: ${e.questionType}\n`,e.question&&(t+=`Q: ${e.question}\n`),"sequence"===e.questionType&&e.correctSequence?(t+="\nCorrect Sequence:\n",e.correctSequence.forEach(e=>{t+=`  ${e.position}. ${e.text}\n`})):(t+="\nAnswers:\n",e.answers.forEach((e,n)=>{const o=e.correct?"[✓]":"[ ]",s=e.sequence?` (pos: ${e.sequence})`:"";t+=`  ${n+1}. ${o} ${e.text}${s}\n`})),t+="\n"}),t}case"csv":{let t="SlideID,Question,QuestionType,Answer,Correct,Sequence\n";return e.forEach(e=>{e.answers.forEach(n=>{const o=(e.question||"").replace(/"/g,'""'),s=(n.text||"").replace(/"/g,'""');t+=`"${e.slideId}","${o}","${e.questionType}","${s}",${n.correct},${n.sequence||""}\n`})}),t}}}(e,t),getSequenceQuestions:e=>e.filter(e=>"sequence"===e.questionType||"drag-drop"===e.questionType),getCorrectAnswers:e=>e.map(e=>"sequence"===e.questionType&&e.correctSequence?{slideId:e.slideId,question:e.question,type:e.questionType,correctAnswer:e.correctSequence.map(e=>`${e.position}. ${e.text}`).join(" → ")}:{slideId:e.slideId,question:e.question,type:e.questionType,correctAnswer:e.answers.filter(e=>e.correct).map(e=>e.text).join(", ")}),findBaseUrl:t,findStorylineScripts:e,discoverDataFiles:o,parseDataJS:s,cleanText:r};if("undefined"!=typeof require&&require.main===module){const e=require("fs"),t=require("path"),n=process.argv.slice(2);0===n.length&&(console.log("Usage: node storyline-data-extractor.js <path-to-file.js> [search-term] [--format=json|text|csv]"),console.log("\nExamples:"),console.log("  node storyline-data-extractor.js ./html5/data/js/data.js"),console.log('  node storyline-data-extractor.js ./data.js "ASOM"'),console.log("  node storyline-data-extractor.js ./data.js --format=text"),console.log("\nNote: Input file should contain globalProvideData() call"),process.exit(1));const o=n[0];let s=null,r="json";for(let e=1;e<n.length;e++)n[e].startsWith("--format=")?r=n[e].split("=")[1]:s=n[e];try{const n=e.readFileSync(o,"utf-8");let c=StorylineExtractor.extractFromDataJS(n);console.error(`[INFO] Extracted ${c.length} questions`),s&&(c=StorylineExtractor.search(c,s),console.error(`[INFO] Found ${c.length} matching "${s}"`));const i=StorylineExtractor.format(c,r);console.log(i);const a=t.basename(o,".js")+"_questions."+("csv"===r?"csv":"text"===r?"txt":"json");e.writeFileSync(a,i),console.error(`[INFO] Written to ${a}`)}catch(e){console.error(`[ERROR] ${e.message}`),process.exit(1)}}"undefined"!=typeof window&&(window.StorylineExtractor=StorylineExtractor,window.StorylineDataExtractor=StorylineExtractor,console.log("[StorylineExtractor] Loaded. Use: await StorylineExtractor.run()")),"undefined"!=typeof module&&module.exports&&(module.exports=StorylineExtractor)}("undefined"!=typeof window?window:global);