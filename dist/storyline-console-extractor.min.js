!async function(){console.log("╔═══════════════════════════════════════════════════════════╗"),console.log("║         STORYLINE QUIZ EXTRACTOR v8.0                     ║"),console.log("║         Auto-running extraction...                        ║"),console.log("╚═══════════════════════════════════════════════════════════╝\n");const e={questionIndicators:["?","select","choose","which","what","identify","match","drag","complete","fill","order","arrange","indicate","determine","find","locate","click","true or false","correct answer","best answer","following","statement","example","describes","represents","demonstrates"],answerAccTypes:["checkbox","radiobutton","button","hotspot","dragitem","dropzone","droptarget","textentry","textinput","input","clickable","selectable"],correctStateIndicators:["_Review","_Selected_Review","Correct","Right","True","Yes","Selected_Correct","Drop_Correct","Drag_Correct","Match_Correct","Answer_Correct"],incorrectStateIndicators:["Incorrect","Wrong","False","No","Drop_Incorrect","Drag_Incorrect"],excludeButtonText:["continue","next","back","previous","submit","exit","close","menu","home","restart","replay","review","try again","start","begin","finish","done","ok","cancel","skip","play","pause","stop","forward","rewind"],minAnswerLength:1,minQuestionLength:10,verbose:!1},o={isPopup:!!window.opener,isIframe:window!==window.top,isMain:window===window.top&&!window.opener};console.log("[Context]",o);const t=function(){const e=new Map,o=new WeakSet;function t(t,n){if(t&&!o.has(t)){o.add(t);try{const o=t.location.href;e.has(o)||e.set(o,{window:t,source:n})}catch(e){}}}t(window,"current");let n=window;for(let e=0;e<20&&n;e++){t(n,`parent_${e}`);try{if(n.parent===n)break;n=n.parent}catch(e){break}}let s=window.opener;for(let e=0;e<10&&s;e++){t(s,`opener_${e}`);let o=s;for(let n=0;n<10&&o;n++){t(o,`opener_${e}_parent_${n}`);try{if(o.parent===o)break;o=o.parent}catch(e){break}}try{s=s.opener}catch(e){break}}for(const{window:t}of e.values())try{t.document.querySelectorAll("iframe, frame").forEach((t,n)=>{try{const s=t.contentWindow;if(s&&!o.has(s)){o.add(s);try{const o=s.location.href;e.set(o,{window:s,source:`frame_${n}`})}catch(e){}}}catch(e){}})}catch(e){}return e}();console.log(`[WindowManager] Found ${t.size} accessible window(s)`);let n=null;for(const[e,{window:o,source:s}]of t)try{if(o.performance?.getEntriesByType){const e=o.performance.getEntriesByType("resource").map(e=>e.name).find(e=>e.includes("/html5/")||e.includes("/story_content/"));if(e&&(n=e.match(/(.*?)\/html5\//)?.[1]||e.match(/(.*?)\/story_content\//)?.[1],n)){console.log(`[Found] Base URL from ${s}:`,n);break}}o.document.querySelectorAll("script[src]").forEach(e=>{!n&&e.src.includes("/html5/")&&(n=e.src.match(/(.*?)\/html5\//)?.[1],n&&console.log(`[Found] Base URL from script in ${s}:`,n))})}catch(e){}if(!n){const e=window.location.href;e.includes("/html5/")?n=e.match(/(.*?)\/html5\//)?.[1]:e.includes("/story")&&(n=e.replace(/\/story.*$/,""))}if(!n)return console.log("Could not find course URL. Please set manually:"),console.log('  window.baseUrl = "YOUR_COURSE_URL";'),void console.log("  Then run script again.");console.log("Base URL:",n),console.log("\nFetching course data...");let s=await fetch(n+"/html5/data/js/data.js"),r=(await s.text()).match(/globalProvideData\s*\(\s*'data'\s*,\s*'(.+)'\s*\)/);if(!r)return void console.log("Could not parse data.js");let l=r[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r"),courseData=JSON.parse(l);console.log("Course data loaded");let c=[];courseData.quizzes?.forEach(e=>{e.sliderefs?.forEach(e=>{let o=e.id.split(".");c.push(o[o.length-1])})}),courseData.scenes?.forEach(e=>{e.slides?.forEach(e=>{e.id&&!c.includes(e.id)&&c.push(e.id)})}),console.log("Found",c.length,"slides to check\n");let allQA=[],a={slidesProcessed:0,slidesWithQA:0,totalQuestions:0,totalAnswers:0,totalCorrect:0,byType:{},skipped:[]};for(let o=0;o<c.length;o++){let t=c[o];try{let s=await fetch(`${n}/html5/data/js/${t}.js`);if(!s.ok)continue;let r=(await s.text()).match(/globalProvideData\s*\(\s*'slide'\s*,\s*'(.+)'\s*\)/);if(!r)continue;let l=r[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r"),d=JSON.parse(l);a.slidesProcessed++;let p=i(d,t,e,a);if(p.answers.length>0){allQA.push(p),a.slidesWithQA++,a.totalQuestions++,a.totalAnswers+=p.answers.length,a.totalCorrect+=p.answers.filter(e=>e.correct).length;let e=p.answers.filter(e=>e.correct).length;console.log(`[${o+1}/${c.length}] ${t}: ${p.answers.length} answers (${e} correct)${p.questionType?" ["+p.questionType+"]":""}`)}}catch(o){e.verbose&&console.log(`Error on ${t}:`,o.message)}}if(console.log("\n=== RESULTS ==="),console.log("Slides processed:",a.slidesProcessed),console.log("Slides with Q&A:",a.slidesWithQA),console.log("Questions found:",a.totalQuestions),console.log("Total answers:",a.totalAnswers),console.log("Correct answers:",a.totalCorrect),Object.keys(a.byType).length>0&&(console.log("\nAnswer types found:"),Object.entries(a.byType).sort((e,o)=>o[1]-e[1]).forEach(([e,o])=>{console.log(`  ${e}: ${o}`)})),a.skipped.length>0){console.log("\nFiltered out:");let e={};a.skipped.forEach(o=>{let t=`${o.reason}`;e[t]=(e[t]||0)+1}),Object.entries(e).forEach(([e,o])=>{console.log(`  ${e}: ${o}`)})}function i(e,o,t,n){let s={slideId:o,question:"",questionType:null,answers:[],rawElements:[]};return function e(o,r=""){if(!o||"object"!=typeof o)return;let l=function(e){return e.textLib?.[0]?.vartext?.blocks?e.textLib[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join("").replace(/\\n/g," ").replace(/\s+/g," ").trim():e.rawText?e.rawText.replace(/\\n/g," ").replace(/\s+/g," ").trim():"string"==typeof e.text?e.text.replace(/\\n/g," ").replace(/\s+/g," ").trim():"string"==typeof e.title?e.title.trim():"string"==typeof e.label?e.label.trim():"string"==typeof e.accText?e.accText.trim():""}(o),c=o.accType;if(function(e){return!!e&&t.answerAccTypes.some(o=>e.toLowerCase()===o.toLowerCase())}(c)&&l&&l.length>=t.minAnswerLength){let e=l.toLowerCase().trim();if("button"===c&&t.excludeButtonText.some(o=>e===o||e.includes(o)))return t.verbose&&console.log(`  Skipped nav button: "${l}"`),void n.skipped.push({text:l,reason:"navigation button",accType:c});if(s.answers.some(e=>e.text===l))return t.verbose&&console.log(`  Skipped duplicate: "${l}"`),void n.skipped.push({text:l,reason:"duplicate",accType:c});let r=function(e){if(!e.states||!Array.isArray(e.states))return!1;let o=e.states.some(e=>t.correctStateIndicators.some(o=>e.name?.toLowerCase().includes(o.toLowerCase()))),n=e.states.every(e=>t.incorrectStateIndicators.some(o=>e.name?.toLowerCase().includes(o.toLowerCase())));return o&&!n}(o);s.answers.push({text:l,correct:r,accType:c,states:o.states?.map(e=>e.name)||[]}),n.byType[c]=(n.byType[c]||0)+1,s.questionType||("checkbox"===c?s.questionType="multiple-select":"radiobutton"===c?s.questionType="multiple-choice":"dragitem"===c||"dropzone"===c||"droptarget"===c?s.questionType="drag-drop":"hotspot"===c?s.questionType="hotspot":"textentry"===c||"textinput"===c?s.questionType="fill-in":"button"===c&&(s.questionType="button-choice")),t.verbose&&console.log(`  Found answer: "${l.substring(0,40)}..." [${c}] correct=${r}`)}"text"!==c&&c||function(e){if(!e||e.length<t.minQuestionLength)return!1;let o=e.toLowerCase();return t.questionIndicators.some(e=>o.includes(e.toLowerCase()))}(l)&&(s.answers.some(e=>e.text===l)?t.verbose&&console.log(`  Skipped as question (is answer): "${l.substring(0,50)}..."`):(!s.question||l.length>s.question.length)&&(s.question=l,t.verbose&&console.log(`  Found question: "${l.substring(0,50)}..."`)));for(let t in o)Array.isArray(o[t])?o[t].forEach((o,n)=>e(o,`${r}.${t}[${n}]`)):"object"==typeof o[t]&&e(o[t],`${r}.${t}`)}(e),s}console.log("\n=== QUESTIONS & ANSWERS ===\n"),allQA.forEach((e,o)=>{console.log(`--- Question ${o+1} [${e.slideId}]${e.questionType?" ("+e.questionType+")":""} ---`),e.question&&console.log("Q:",e.question),e.answers.forEach((e,o)=>{e.correct;let t=e.accType?` (${e.accType})`:"";console.log(`  ${o+1}. ${e.correct?"[X]":"[ ]"} ${e.text}${t}`)}),console.log("")}),window.allQA=allQA,window.courseData=courseData,window.extractorStats=a,window.extractorConfig=e,window.windowContext=o,console.log("\n╔═══════════════════════════════════════════════════════════╗"),console.log("║ EXTRACTION COMPLETE                                       ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Saved to window:                                          ║"),console.log("║   window.allQA           - all questions/answers          ║"),console.log("║   window.courseData      - full course data               ║"),console.log("║   window.extractorStats  - detection statistics           ║"),console.log("║   window.windowContext   - window/frame context           ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Commands:                                                 ║"),console.log('║   exportQA("json")       - download as JSON               ║'),console.log('║   exportQA("txt")        - download readable format       ║'),console.log("╚═══════════════════════════════════════════════════════════╝"),window.exportQA=function(e="json"){let o=window.allQA,t="",n="answer_key",s="application/json";"json"===e?(t=JSON.stringify(o,null,2),n="answer_key.json",s="application/json"):(t="=== ANSWER KEY ===\n\n",o.forEach((e,o)=>{t+=`--- Question ${o+1} [${e.slideId}]${e.questionType?" ("+e.questionType+")":""} ---\n`,e.question&&(t+=`Q: ${e.question}\n`),e.answers.forEach((e,o)=>{t+=`${o+1}. ${e.correct?"[X] CORRECT":"[ ]"} ${e.text}\n`}),t+="\n"}),t+="\n=== CORRECT ANSWERS ONLY ===\n\n",o.forEach((e,o)=>{let n=e.answers.filter(e=>e.correct);n.length&&(t+=`Q${o+1}: ${n.map(e=>e.text).join(" | ")}\n`)}),n="answer_key.txt",s="text/plain");let r=new Blob([t],{type:s}),l=document.createElement("a");l.href=URL.createObjectURL(r),l.download=n,l.click(),console.log("Downloaded",n)}}();