!function(){"use strict";const e={detectContext(){const e={isPopup:!!window.opener,isIframe:window!==window.top,isTopLevel:window===window.top&&!window.opener,hasOpener:!!window.opener,openerAccessible:!1,parentAccessible:!1,topAccessible:!1,windowName:window.name||"(unnamed)",depth:0};if(window.opener)try{window.opener.location.href,e.openerAccessible=!0}catch(t){e.openerAccessible=!1}if(window.parent&&window.parent!==window)try{window.parent.location.href,e.parentAccessible=!0}catch(t){e.parentAccessible=!1}if(window.top&&window.top!==window)try{window.top.location.href,e.topAccessible=!0}catch(t){e.topAccessible=!1}let t=window;for(;t!==t.parent;){e.depth++;try{t=t.parent}catch(e){break}if(e.depth>20)break}return e},getAllWindows(){const e=new Map,t=new WeakSet,o=(o,s)=>{if(o&&!t.has(o)){t.add(o);try{const t=o.location.href;e.has(t)||e.set(t,{window:o,source:s})}catch(e){}}};o(window,"current");let s=window;for(let e=0;e<20&&s;e++){o(s,`parent_${e}`);try{if(s.parent===s)break;s=s.parent}catch(e){break}}let n=window.opener;for(let e=0;e<10&&n;e++){o(n,`opener_${e}`);let t=n;for(let s=0;s<10&&t;s++){o(t,`opener_${e}_parent_${s}`);try{if(t.parent===t)break;t=t.parent}catch(e){break}}try{n=n.opener}catch(e){break}}for(const{window:o}of e.values())this.collectFrames(o,e,t);return e},collectFrames(e,t,o){try{e.document.querySelectorAll("iframe, frame").forEach((e,s)=>{try{const n=e.contentWindow;if(n&&!o.has(n)){o.add(n);try{const r=n.location.href;t.has(r)||t.set(r,{window:n,source:`frame_${s}`,frameElement:e}),this.collectFrames(n,t,o)}catch(e){}}}catch(e){}})}catch(e){}},findSCORMAPIGlobal(){const e=this.getAllWindows();console.log(`[WindowManager] Searching ${e.size} window(s) for SCORM API...`);for(const[t,{window:o,source:s}]of e)try{if(o.API_1484_11?.GetValue)return console.log(`[WindowManager] Found SCORM 2004 API in ${s} (${t})`),{api:o.API_1484_11,version:"2004",window:o,source:s};if(o.API?.LMSGetValue)return console.log(`[WindowManager] Found SCORM 1.2 API in ${s} (${t})`),{api:{GetValue:e=>o.API.LMSGetValue(e),SetValue:(e,t)=>o.API.LMSSetValue(e,t),Commit:()=>o.API.LMSCommit("")},version:"1.2",window:o,source:s}}catch(e){}return null},findStorylineGlobal(){const e=this.getAllWindows(),t={DS:null,player:null,_storylineData:null};for(const[o,{window:s,source:n}]of e)try{s.DS&&!t.DS&&(console.log(`[WindowManager] Found window.DS in ${n}`),t.DS={data:s.DS,window:s,source:n}),s.player&&!t.player&&(console.log(`[WindowManager] Found window.player in ${n}`),t.player={data:s.player,window:s,source:n}),s._storylineData&&!t._storylineData&&(console.log(`[WindowManager] Found window._storylineData in ${n}`),t._storylineData={data:s._storylineData,window:s,source:n})}catch(e){}return t},findTLAGlobal(){const e=this.getAllWindows(),t={ADL:null,xAPI:null};for(const[o,{window:s,source:n}]of e)try{s.ADL?.XAPIWrapper&&!t.ADL&&(console.log(`[WindowManager] Found ADL.XAPIWrapper in ${n}`),t.ADL={data:s.ADL,window:s,source:n})}catch(e){}return t},scanAllFramesForQuizElements(){const e=this.getAllWindows(),t=[],o=['[data-acc-type="radiobutton"]','[data-acc-type="checkbox"]','[data-acc-type="button"]','[class*="quiz"]','[class*="question"]','[class*="answer"]','[role="radio"]','[role="checkbox"]','input[type="radio"]','input[type="checkbox"]'].join(", ");for(const[s,{window:n,source:r}]of e)try{n.document.querySelectorAll(o).forEach(e=>{t.push({source:r,url:s,text:e.textContent?.trim()?.substring(0,200),tagName:e.tagName,accType:e.dataset?.accType,role:e.getAttribute("role"),type:e.type})})}catch(e){}return t}},LMSExtractor={results:{questions:[],answers:[],completion:null,context:null},windowManager:e,extractStoryline(){const t=[],o=e.findStorylineGlobal();o.DS&&(console.log("[Extractor] Extracting from window.DS"),this.extractFromDS(o.DS.data,t)),o.player&&(console.log("[Extractor] Extracting from window.player"),this.extractFromPlayer(o.player.data,t)),o._storylineData&&(console.log("[Extractor] Extracting from _storylineData"),this.parseStorylineData(o._storylineData.data,t));const s=e.scanAllFramesForQuizElements();return s.length>0&&(console.log(`[Extractor] Found ${s.length} quiz elements across frames`),s.forEach(e=>{e.text&&e.text.length>0&&t.push({source:`Frame: ${e.source}`,text:e.text,element:e.tagName,accType:e.accType||e.role||e.type})})),t},extractFromDS(e,t){try{const o=e.getAll?e.getAll():e;for(const[e,s]of Object.entries(o))(e.includes("Quiz")||e.includes("Question")||e.includes("Answer"))&&t.push({source:"DS",key:e,value:s})}catch(e){console.warn("[Extractor] DS extraction error:",e)}},extractFromPlayer(e,t){try{e.GetVar&&["Score","ScorePercent","PassPercent","PassFail"].forEach(o=>{const s=e.GetVar(o);void 0!==s&&t.push({source:"Player",key:o,value:s})})}catch(e){console.warn("[Extractor] Player extraction error:",e)}},parseStorylineData(e,t){try{if(e.scenes)for(const o of e.scenes)if(o.slides)for(const e of o.slides)if(e.interactions)for(const o of e.interactions)t.push({source:"StorylineData",slideId:e.id,type:o.type,choices:o.choices?.map(e=>({text:e.text||e.label,correct:e.correct||e.isCorrect}))})}catch(e){console.warn("[Extractor] Storyline data parsing error:",e)}},async extractTLA(){const t=[],o=this.findTasksJsonUrl();if(o)try{const e=await fetch(o),s=await e.json();this.parseTasksJson(s,t)}catch(e){console.warn("[Extractor] tasks.json fetch error:",e)}return e.findTLAGlobal().ADL&&console.log("[Extractor] Found ADL xAPI Wrapper"),t},findTasksJsonUrl(){const e=new URLSearchParams(window.location.search).get("contentUrl");if(e)return`/api/assets/tasks.json?contentUrl=${encodeURIComponent(e)}`;const t=performance.getEntriesByType("resource").find(e=>e.name.includes("tasks.json"));return t?.name},parseTasksJson(e,t){if(e?.taskGroups)for(const o of e.taskGroups)for(const e of o.tasks||[])for(const o of e.questions||[])t.push({source:"TLA",id:o.id,prompt:o.prompt,type:o.type,choices:o.choices,correctPattern:o.correctPattern,correct:this.parseCorrectPattern(o.correctPattern,o.type)})},parseCorrectPattern(e,t){if(!e)return null;const o="[,]";switch(t){case"CHOICE":return e.split(o);case"FILL_IN":case"LONG_FILL_IN":if(e.startsWith("{case_matters=")){const t=e.indexOf("}");return{caseMatters:"true"===e.substring(14,t),answers:e.substring(t+1).split(o)}}return{answers:e.split(o)};case"MATCHING":return e.split(o).map(e=>{const[t,o]=e.split("[.]");return{source:t,target:o}});case"SEQUENCING":return e.split(o).map((e,t)=>({position:t+1,item:e}));case"TRUE_FALSE":return"true"===e.toLowerCase();default:return e}},extractSCORM(){const t=[],o=e.findSCORMAPIGlobal();if(!o)return console.log("[Extractor] No SCORM API found in any window"),t;console.log(`[Extractor] Using SCORM ${o.version} API from ${o.source}`);const s=o.api;try{const e=parseInt(s.GetValue("cmi.interactions._count")||"0");console.log(`[Extractor] Found ${e} SCORM interactions`);for(let o=0;o<e;o++)t.push({source:"SCORM",id:s.GetValue(`cmi.interactions.${o}.id`),type:s.GetValue(`cmi.interactions.${o}.type`),description:s.GetValue(`cmi.interactions.${o}.description`),correctResponse:s.GetValue(`cmi.interactions.${o}.correct_responses.0.pattern`),learnerResponse:s.GetValue(`cmi.interactions.${o}.learner_response`),result:s.GetValue(`cmi.interactions.${o}.result`)})}catch(e){console.warn("[Extractor] SCORM interaction error:",e)}return t},completeSCORM(t=100){const o=e.findSCORMAPIGlobal();if(!o)return console.error("[Completion] No SCORM API found"),!1;const s=o.api;try{return"2004"===o.version?(s.SetValue("cmi.score.raw",String(t)),s.SetValue("cmi.score.scaled",String(t/100)),s.SetValue("cmi.score.min","0"),s.SetValue("cmi.score.max","100"),s.SetValue("cmi.success_status",t>=70?"passed":"failed"),s.SetValue("cmi.completion_status","completed")):(s.SetValue("cmi.core.score.raw",String(t)),s.SetValue("cmi.core.lesson_status",t>=70?"passed":"completed")),s.Commit(),console.log(`[Completion] SCORM ${o.version} completion set: score=${t}`),!0}catch(e){return console.error("[Completion] SCORM completion failed:",e),!1}},async completeTLA(e,t){if(!e){const t=window.location.href.match(/sessions?\/([a-z]{2}-[0-9a-f-]+)/i);e=t?.[1]}if(t||(t=new URLSearchParams(window.location.search).get("contentUrl")),!e)return console.error("[Completion] No session ID found"),!1;try{let o=null;if(t){const e=await fetch(`/api/assets/tasks.json?contentUrl=${encodeURIComponent(t)}`);e.ok&&(o=await e.json())}const s={answers:{},viewedTasks:[],viewedTaskGroups:[],completedTasks:[],completedTaskGroups:[],questionResults:{}};if(o?.taskGroups){console.log(`[Completion] Processing ${o.taskGroups.length} task groups...`);for(const e of o.taskGroups){const t=e.id||e.slug;s.viewedTaskGroups.push(t);for(const t of e.tasks||[]){const e=t.id||t.slug;s.viewedTasks.push(e);for(const e of t.questions||[]){const t=e.id,o=this.generateTLAAnswer(e);s.answers[t]=o,s.questionResults[t]={answered:!0,correct:!0,response:o,attempts:1}}s.completedTasks.push(e)}s.completedTaskGroups.push(t)}}let n={};try{const t=await fetch(`/api/sessions/${e}/lrs/state`);t.ok&&(n=await t.json()||{})}catch(e){}const r={...n,...s,answers:{...n.answers,...s.answers},viewedTasks:[...new Set([...n.viewedTasks||[],...s.viewedTasks])],viewedTaskGroups:[...new Set([...n.viewedTaskGroups||[],...s.viewedTaskGroups])],completedTasks:[...new Set([...n.completedTasks||[],...s.completedTasks])],completedTaskGroups:[...new Set([...n.completedTaskGroups||[],...s.completedTaskGroups])],questionResults:{...n.questionResults,...s.questionResults}};if(await fetch(`/api/sessions/${e}/lrs/state`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),console.log(`[Completion] LRS state updated with ${Object.keys(s.answers).length} answers`),(await fetch(`/api/sessions/${e}/score`,{method:"POST"})).ok)return console.log(`[Completion] TLA score submitted for session ${e}`),!0}catch(e){console.error("[Completion] TLA completion failed:",e)}return!1},generateTLAAnswer(e){const t=e.correctPattern,o=e.type,s="[,]";if(!t)return"";switch(o){case"CHOICE":return t.split(s);case"FILL_IN":case"LONG_FILL_IN":if(t.startsWith("{case_matters=")){const e=t.indexOf("}");return t.substring(e+1).split(s)[0]}return t.split(s)[0];case"MATCHING":case"SEQUENCING":default:return t;case"TRUE_FALSE":return"true"===t.toLowerCase()}},async extract(){console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Starting extraction..."),console.log("═══════════════════════════════════════════════════");const t=e.detectContext();this.results.context=t,console.log("[Context]",{isPopup:t.isPopup,isIframe:t.isIframe,frameDepth:t.depth,windowName:t.windowName});const o=[];return console.log("\n[Storyline] Checking..."),o.push(...this.extractStoryline()),console.log("\n[TLA/xAPI] Checking..."),o.push(...await this.extractTLA()),console.log("\n[SCORM] Checking..."),o.push(...this.extractSCORM()),this.results.questions=o,console.log("\n═══════════════════════════════════════════════════"),console.log(`[LMS Extractor] Found ${o.length} items`),console.log("═══════════════════════════════════════════════════"),o.length>0&&console.table(o),o},getCorrectAnswers(){return this.results.questions.filter(e=>e.correct||e.correctResponse||e.correctPattern)},async complete(e=100){return console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Attempting completion..."),console.log("═══════════════════════════════════════════════════"),this.completeSCORM(e)?(this.results.completion="SCORM",!0):await this.completeTLA()?(this.results.completion="TLA",!0):(console.warn("[LMS Extractor] Could not complete course automatically"),!1)},export(e="json"){const t={url:window.location.href,timestamp:(new Date).toISOString(),context:this.results.context,questions:this.results.questions,correctAnswers:this.getCorrectAnswers()};if("json"===e)return JSON.stringify(t,null,2);if("text"===e){let e="LMS Extraction Results\n";return e+=`URL: ${t.url}\n`,e+=`Time: ${t.timestamp}\n`,e+=`Context: ${t.context?.isPopup?"Popup":t.context?.isIframe?"Iframe":"Main"}\n\n`,e+="=== QUESTIONS & ANSWERS ===\n\n",t.questions.forEach((t,o)=>{e+=`Q${o+1}: ${t.prompt||t.description||t.text||"N/A"}\n`,e+=`Type: ${t.type||"unknown"}\n`,t.correct&&(e+=`Correct: ${JSON.stringify(t.correct)}\n`),t.correctPattern&&(e+=`Pattern: ${t.correctPattern}\n`),t.correctResponse&&(e+=`Response: ${t.correctResponse}\n`),e+="\n"}),e}return t},download(e="json"){const t=this.export(e),o=new Blob([t],{type:"json"===e?"application/json":"text/plain"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`lms_extraction_${Date.now()}.${"json"===e?"json":"txt"}`,s.click()},windows:e};window.LMSExtractor=LMSExtractor,console.log("╔═══════════════════════════════════════════════════════════╗"),console.log("║        LMS EXTRACTOR & COMPLETION TOOL v8.0               ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Auto-running extraction...                                ║"),console.log("╚═══════════════════════════════════════════════════════════╝"),LMSExtractor.extract().then(e=>{console.log("\n╔═══════════════════════════════════════════════════════════╗"),console.log("║ EXTRACTION COMPLETE                                       ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Additional commands:                                      ║"),console.log("║   LMSExtractor.complete()    - Mark course complete       ║"),console.log("║   LMSExtractor.export()      - Get results as JSON        ║"),console.log("║   LMSExtractor.download()    - Save results to file       ║"),console.log("║   LMSExtractor.windows.getAllWindows() - List all windows ║"),console.log("╚═══════════════════════════════════════════════════════════╝")}).catch(e=>{console.error("[LMS Extractor] Error:",e)})}();