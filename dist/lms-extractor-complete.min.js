!function(){"use strict";const e={detectContext(){const e={isPopup:!!window.opener,isIframe:window!==window.top,isTopLevel:window===window.top&&!window.opener,hasOpener:!!window.opener,openerAccessible:!1,parentAccessible:!1,topAccessible:!1,windowName:window.name||"(unnamed)",depth:0};if(window.opener)try{window.opener.location.href,e.openerAccessible=!0}catch(t){e.openerAccessible=!1}if(window.parent&&window.parent!==window)try{window.parent.location.href,e.parentAccessible=!0}catch(t){e.parentAccessible=!1}if(window.top&&window.top!==window)try{window.top.location.href,e.topAccessible=!0}catch(t){e.topAccessible=!1}let t=window;for(;t!==t.parent;){e.depth++;try{t=t.parent}catch(e){break}if(e.depth>20)break}return e},getAllWindows(){const e=new Map,t=new WeakSet,o=(o,s)=>{if(o&&!t.has(o)){t.add(o);try{const t=o.location.href;e.has(t)||e.set(t,{window:o,source:s})}catch(e){}}};o(window,"current");let s=window;for(let e=0;e<20&&s;e++){o(s,`parent_${e}`);try{if(s.parent===s)break;s=s.parent}catch(e){break}}let r=window.opener;for(let e=0;e<10&&r;e++){o(r,`opener_${e}`);let t=r;for(let s=0;s<10&&t;s++){o(t,`opener_${e}_parent_${s}`);try{if(t.parent===t)break;t=t.parent}catch(e){break}}try{r=r.opener}catch(e){break}}for(const{window:o}of e.values())this.collectFrames(o,e,t);return e},collectFrames(e,t,o){try{e.document.querySelectorAll("iframe, frame").forEach((e,s)=>{try{const r=e.contentWindow;if(r&&!o.has(r)){o.add(r);try{const n=r.location.href;t.has(n)||t.set(n,{window:r,source:`frame_${s}`,frameElement:e}),this.collectFrames(r,t,o)}catch(e){}}}catch(e){}})}catch(e){}},findSCORMAPIGlobal(){const e=this.getAllWindows();console.log(`[WindowManager] Searching ${e.size} window(s) for SCORM API...`);for(const[t,{window:o,source:s}]of e)try{if(o.API_1484_11?.GetValue)return console.log(`[WindowManager] Found SCORM 2004 API in ${s} (${t})`),{api:o.API_1484_11,version:"2004",window:o,source:s};if(o.API?.LMSGetValue)return console.log(`[WindowManager] Found SCORM 1.2 API in ${s} (${t})`),{api:{GetValue:e=>o.API.LMSGetValue(e),SetValue:(e,t)=>o.API.LMSSetValue(e,t),Commit:()=>o.API.LMSCommit("")},version:"1.2",window:o,source:s}}catch(e){}return null},findStorylineGlobal(){const e=this.getAllWindows(),t={DS:null,player:null,_storylineData:null};for(const[o,{window:s,source:r}]of e)try{s.DS&&!t.DS&&(console.log(`[WindowManager] Found window.DS in ${r}`),t.DS={data:s.DS,window:s,source:r}),s.player&&!t.player&&(console.log(`[WindowManager] Found window.player in ${r}`),t.player={data:s.player,window:s,source:r}),s._storylineData&&!t._storylineData&&(console.log(`[WindowManager] Found window._storylineData in ${r}`),t._storylineData={data:s._storylineData,window:s,source:r})}catch(e){}return t},findTLAGlobal(){const e=this.getAllWindows(),t={ADL:null,xAPI:null};for(const[o,{window:s,source:r}]of e)try{s.ADL?.XAPIWrapper&&!t.ADL&&(console.log(`[WindowManager] Found ADL.XAPIWrapper in ${r}`),t.ADL={data:s.ADL,window:s,source:r})}catch(e){}return t},scanAllFramesForQuizElements(){const e=this.getAllWindows(),t=[],o=['[data-acc-type="radiobutton"]','[data-acc-type="checkbox"]','[data-acc-type="button"]','[class*="quiz"]','[class*="question"]','[class*="answer"]','[role="radio"]','[role="checkbox"]','input[type="radio"]','input[type="checkbox"]'].join(", ");for(const[s,{window:r,source:n}]of e)try{r.document.querySelectorAll(o).forEach(e=>{t.push({source:n,url:s,text:e.textContent?.trim()?.substring(0,200),tagName:e.tagName,accType:e.dataset?.accType,role:e.getAttribute("role"),type:e.type})})}catch(e){}return t}},LMSExtractor={results:{questions:[],answers:[],completion:null,context:null},windowManager:e,extractStoryline(){const t=[],o=e.findStorylineGlobal();o.DS&&(console.log("[Extractor] Extracting from window.DS"),this.extractFromDS(o.DS.data,t)),o.player&&(console.log("[Extractor] Extracting from window.player"),this.extractFromPlayer(o.player.data,t)),o._storylineData&&(console.log("[Extractor] Extracting from _storylineData"),this.parseStorylineData(o._storylineData.data,t));const s=e.scanAllFramesForQuizElements();return s.length>0&&(console.log(`[Extractor] Found ${s.length} quiz elements across frames`),s.forEach(e=>{e.text&&e.text.length>0&&t.push({source:`Frame: ${e.source}`,text:e.text,element:e.tagName,accType:e.accType||e.role||e.type})})),t},extractFromDS(e,t){try{if("function"!=typeof e.GetVar){console.log("[Extractor] DS has no GetVar method, checking properties");for(const[o,s]of Object.entries(e))"function"!=typeof s&&t.push({source:"DS_Property",key:o,value:s});return}["Results.ScorePoints","Results.ScorePercent","Results.PassPercent","Results.PassPoints","Results.QuizPointsAvailable","Results.QuizPointsScored","Score","ScorePercent","ScorePoints","PassFail","PassPercent","QuizResult","Passed","Failed","Complete"].forEach(o=>{try{const s=e.GetVar(o);null!=s&&""!==s&&t.push({source:"DS",key:o,value:s})}catch(e){}});for(let o=1;o<=50;o++)["Answer","Correct","Response","Result","Points","Selected"].forEach(s=>{try{const r=`Q${o}_${s}`,n=e.GetVar(r);null!=n&&""!==n&&t.push({source:"DS",key:r,value:n})}catch(e){}});console.log(`[Extractor] Extracted ${t.length} DS variables`)}catch(e){console.warn("[Extractor] DS extraction error:",e)}},extractFromPlayer(e,t){try{if("function"!=typeof e.GetVar)return void console.log("[Extractor] Player has no GetVar method");if(["Results.ScorePoints","Results.ScorePercent","Results.PassPercent","Results.PassPoints","Results.QuizPointsAvailable","Results.QuizPointsScored","Score","ScorePercent","ScorePoints","PassFail","PassPercent","Progress","Complete","Completion","Status","CurrentSlide","SlideNumber","TotalSlides","PlayerVersion","ProjectId"].forEach(o=>{try{const s=e.GetVar(o);null!=s&&""!==s&&t.push({source:"Player",key:o,value:s})}catch(e){}}),e._variables||e.variables){const o=e._variables||e.variables;console.log(`[Extractor] Found player variables store with ${Object.keys(o).length} entries`);for(const[e,s]of Object.entries(o))"function"!=typeof s&&t.push({source:"Player_Internal",key:e,value:s})}for(let o=1;o<=50;o++)["Answer","Correct","Response","Result","Points","Selected","Choice"].forEach(s=>{try{const r=`Question${o}_${s}`,n=e.GetVar(r);null!=n&&""!==n&&t.push({source:"Player",key:r,value:n})}catch(e){}});console.log(`[Extractor] Extracted ${t.length} Player variables`)}catch(e){console.warn("[Extractor] Player extraction error:",e)}},parseStorylineData(e,t){try{const o=["_Review","_Selected_Review","Correct","Right","True","Selected_Correct","Drop_Correct","Drag_Correct"],s=["checkbox","radiobutton","button","hotspot","dragitem","dropzone","droptarget","textentry"],r=["continue","next","back","previous","submit","exit","close","menu","home","restart","replay","review"],n=e=>e?.textLib?.[0]?.vartext?.blocks?e.textLib[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join("").replace(/\\n/g," ").replace(/\s+/g," ").trim():e?.rawText?e.rawText.trim():"string"==typeof e?.text?e.text.trim():"string"==typeof e?.title?e.title.trim():"string"==typeof e?.accText?e.accText.trim():"",a=e=>!(!e?.states||!Array.isArray(e.states))&&e.states.some(e=>o.some(t=>e.name?.toLowerCase().includes(t.toLowerCase()))),c=(e,o="unknown")=>{if(!e||"object"!=typeof e)return;const i=n(e),l=e.accType?.toLowerCase();if(l&&s.includes(l)&&i){const s=i.toLowerCase();if("button"===l&&r.some(e=>s.includes(e)))return;if(t.some(e=>e.text===i&&e.slideId===o))return;t.push({source:"StorylineData",slideId:o,text:i,accType:l,correct:a(e),states:e.states?.map(e=>e.name)||[]})}for(const t in e)Array.isArray(e[t])?e[t].forEach(e=>c(e,o)):"object"==typeof e[t]&&c(e[t],o)};if(e.slideLayers||e.objects||e.timeline)c(e,e.slideId||"slide");else if(e.scenes)for(const t of e.scenes)for(const e of t.slides||[])c(e,e.id);else c(e);console.log(`[Extractor] Parsed ${t.length} items from Storyline data`)}catch(e){console.warn("[Extractor] Storyline data parsing error:",e)}},async extractTLA(){const t=[],o=this.findTasksJsonUrl();if(o)try{const e=await fetch(o),s=await e.json();this.parseTasksJson(s,t)}catch(e){console.warn("[Extractor] tasks.json fetch error:",e)}const s=e.findTLAGlobal();return s.ADL&&(console.log("[Extractor] Extracting from ADL xAPI Wrapper"),await this.extractFromXAPI(s.ADL.data,t)),t},async extractFromXAPI(e,t){try{const o=e.XAPIWrapper;if(!o)return void console.log("[Extractor] No XAPIWrapper found in ADL");const s=o.lrs||o.Config||{};if(console.log("[Extractor] xAPI endpoint:",s.endpoint),"function"==typeof o.getStatements)try{const e=o.getStatements({verb:"http://adlnet.gov/expapi/verbs/answered",limit:100});e?.statements&&(console.log(`[Extractor] Found ${e.statements.length} xAPI answered statements`),e.statements.forEach(e=>{t.push({source:"xAPI",id:e.object?.id,verb:e.verb?.display?.["en-US"]||e.verb?.id,result:e.result?.response,success:e.result?.success,score:e.result?.score,timestamp:e.timestamp})}))}catch(e){console.warn("[Extractor] getStatements error:",e.message)}if(o.statements||o._statements){const e=o.statements||o._statements;Array.isArray(e)&&e.length>0&&(console.log(`[Extractor] Found ${e.length} cached xAPI statements`),e.forEach(e=>{t.push({source:"xAPI_Cached",id:e.object?.id,verb:e.verb?.display?.["en-US"]||e.verb?.id,result:e.result?.response,success:e.result?.success,score:e.result?.score})}))}if("function"==typeof o.getState)try{const e=s.activityId||window.location.href.split("?")[0],r=o.getState(e,{stateId:"progress"});r&&(console.log("[Extractor] Found xAPI state data"),t.push({source:"xAPI_State",type:"progress",data:r}))}catch(e){}if("function"==typeof o.getActivityProfile)try{const e=s.activityId||window.location.href.split("?")[0],r=o.getActivityProfile(e,"quiz-results");r&&(console.log("[Extractor] Found xAPI activity profile"),t.push({source:"xAPI_Profile",type:"quiz-results",data:r}))}catch(e){}}catch(e){console.warn("[Extractor] xAPI extraction error:",e)}},findTasksJsonUrl(){const e=new URLSearchParams(window.location.search).get("contentUrl");if(e)return`/api/assets/tasks.json?contentUrl=${encodeURIComponent(e)}`;const t=performance.getEntriesByType("resource").find(e=>e.name.includes("tasks.json"));return t?.name},parseTasksJson(e,t){if(e?.taskGroups)for(const o of e.taskGroups)for(const e of o.tasks||[])for(const o of e.questions||[])t.push({source:"TLA",id:o.id,prompt:o.prompt,type:o.type,choices:o.choices,correctPattern:o.correctPattern,correct:this.parseCorrectPattern(o.correctPattern,o.type)})},parseCorrectPattern(e,t){if(!e)return null;const o="[,]";switch(t){case"CHOICE":return e.split(o);case"FILL_IN":case"LONG_FILL_IN":if(e.startsWith("{case_matters=")){const t=e.indexOf("}");return{caseMatters:"true"===e.substring(14,t),answers:e.substring(t+1).split(o)}}return{answers:e.split(o)};case"MATCHING":return e.split(o).map(e=>{const[t,o]=e.split("[.]");return{source:t,target:o}});case"SEQUENCING":return e.split(o).map((e,t)=>({position:t+1,item:e}));case"TRUE_FALSE":return"true"===e.toLowerCase();default:return e}},extractSCORM(){const t=[],o=e.findSCORMAPIGlobal();if(!o)return console.log("[Extractor] No SCORM API found in any window"),t;console.log(`[Extractor] Using SCORM ${o.version} API from ${o.source}`);const s=o.api;try{const e=parseInt(s.GetValue("cmi.interactions._count")||"0");console.log(`[Extractor] Found ${e} SCORM interactions`);for(let o=0;o<e;o++)t.push({source:"SCORM",id:s.GetValue(`cmi.interactions.${o}.id`),type:s.GetValue(`cmi.interactions.${o}.type`),description:s.GetValue(`cmi.interactions.${o}.description`),correctResponse:s.GetValue(`cmi.interactions.${o}.correct_responses.0.pattern`),learnerResponse:s.GetValue(`cmi.interactions.${o}.learner_response`),result:s.GetValue(`cmi.interactions.${o}.result`)})}catch(e){console.warn("[Extractor] SCORM interaction error:",e)}return t},completeSCORM(t=100){const o=e.findSCORMAPIGlobal();if(!o)return console.error("[Completion] No SCORM API found"),!1;const s=o.api;try{return"2004"===o.version?(s.SetValue("cmi.score.raw",String(t)),s.SetValue("cmi.score.scaled",String(t/100)),s.SetValue("cmi.score.min","0"),s.SetValue("cmi.score.max","100"),s.SetValue("cmi.success_status",t>=70?"passed":"failed"),s.SetValue("cmi.completion_status","completed")):(s.SetValue("cmi.core.score.raw",String(t)),s.SetValue("cmi.core.lesson_status",t>=70?"passed":"completed")),s.Commit(),console.log(`[Completion] SCORM ${o.version} completion set: score=${t}`),!0}catch(e){return console.error("[Completion] SCORM completion failed:",e),!1}},async completeTLA(e,t){if(!e){const t=window.location.href.match(/sessions?\/([a-z]{2}-[0-9a-f-]+)/i);e=t?.[1]}if(t||(t=new URLSearchParams(window.location.search).get("contentUrl")),!e)return console.error("[Completion] No session ID found"),!1;try{let o=null;if(t){const e=await fetch(`/api/assets/tasks.json?contentUrl=${encodeURIComponent(t)}`);e.ok&&(o=await e.json())}const s={answers:{},viewedTasks:[],viewedTaskGroups:[],completedTasks:[],completedTaskGroups:[],questionResults:{}};if(o?.taskGroups){console.log(`[Completion] Processing ${o.taskGroups.length} task groups...`);for(const e of o.taskGroups){const t=e.id||e.slug;s.viewedTaskGroups.push(t);for(const t of e.tasks||[]){const e=t.id||t.slug;s.viewedTasks.push(e);for(const e of t.questions||[]){const t=e.id,o=this.generateTLAAnswer(e);s.answers[t]=o,s.questionResults[t]={answered:!0,correct:!0,response:o,attempts:1}}s.completedTasks.push(e)}s.completedTaskGroups.push(t)}}let r={};try{const t=await fetch(`/api/sessions/${e}/lrs/state`);t.ok&&(r=await t.json()||{})}catch(e){}const n={...r,...s,answers:{...r.answers,...s.answers},viewedTasks:[...new Set([...r.viewedTasks||[],...s.viewedTasks])],viewedTaskGroups:[...new Set([...r.viewedTaskGroups||[],...s.viewedTaskGroups])],completedTasks:[...new Set([...r.completedTasks||[],...s.completedTasks])],completedTaskGroups:[...new Set([...r.completedTaskGroups||[],...s.completedTaskGroups])],questionResults:{...r.questionResults,...s.questionResults}};if(await fetch(`/api/sessions/${e}/lrs/state`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),console.log(`[Completion] LRS state updated with ${Object.keys(s.answers).length} answers`),(await fetch(`/api/sessions/${e}/score`,{method:"POST"})).ok)return console.log(`[Completion] TLA score submitted for session ${e}`),!0}catch(e){console.error("[Completion] TLA completion failed:",e)}return!1},generateTLAAnswer(e){const t=e.correctPattern,o=e.type,s="[,]";if(!t)return"";switch(o){case"CHOICE":return t.split(s);case"FILL_IN":case"LONG_FILL_IN":if(t.startsWith("{case_matters=")){const e=t.indexOf("}");return t.substring(e+1).split(s)[0]}return t.split(s)[0];case"MATCHING":case"SEQUENCING":default:return t;case"TRUE_FALSE":return"true"===t.toLowerCase()}},async extract(){console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Starting extraction..."),console.log("═══════════════════════════════════════════════════");const t=e.detectContext();this.results.context=t,console.log("[Context]",{isPopup:t.isPopup,isIframe:t.isIframe,frameDepth:t.depth,windowName:t.windowName});const o=[];return console.log("\n[Storyline] Checking..."),o.push(...this.extractStoryline()),console.log("\n[TLA/xAPI] Checking..."),o.push(...await this.extractTLA()),console.log("\n[SCORM] Checking..."),o.push(...this.extractSCORM()),this.results.questions=o,console.log("\n═══════════════════════════════════════════════════"),console.log(`[LMS Extractor] Found ${o.length} items`),console.log("═══════════════════════════════════════════════════"),o.length>0&&console.table(o),o},getCorrectAnswers(){return this.results.questions.filter(e=>e.correct||e.correctResponse||e.correctPattern)},async complete(e=100){return console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Attempting completion..."),console.log("═══════════════════════════════════════════════════"),this.completeSCORM(e)?(this.results.completion="SCORM",!0):await this.completeTLA()?(this.results.completion="TLA",!0):(console.warn("[LMS Extractor] Could not complete course automatically"),!1)},export(e="json"){const t={url:window.location.href,timestamp:(new Date).toISOString(),context:this.results.context,questions:this.results.questions,correctAnswers:this.getCorrectAnswers()};if("json"===e)return JSON.stringify(t,null,2);if("text"===e){let e="LMS Extraction Results\n";return e+=`URL: ${t.url}\n`,e+=`Time: ${t.timestamp}\n`,e+=`Context: ${t.context?.isPopup?"Popup":t.context?.isIframe?"Iframe":"Main"}\n\n`,e+="=== QUESTIONS & ANSWERS ===\n\n",t.questions.forEach((t,o)=>{e+=`Q${o+1}: ${t.prompt||t.description||t.text||"N/A"}\n`,e+=`Type: ${t.type||"unknown"}\n`,t.correct&&(e+=`Correct: ${JSON.stringify(t.correct)}\n`),t.correctPattern&&(e+=`Pattern: ${t.correctPattern}\n`),t.correctResponse&&(e+=`Response: ${t.correctResponse}\n`),e+="\n"}),e}return t},download(e="json"){const t=this.export(e),o=new Blob([t],{type:"json"===e?"application/json":"text/plain"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`lms_extraction_${Date.now()}.${"json"===e?"json":"txt"}`,s.click()},windows:e};window.LMSExtractor=LMSExtractor,console.log("╔═══════════════════════════════════════════════════════════╗"),console.log("║        LMS EXTRACTOR & COMPLETION TOOL v8.0               ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Auto-running extraction...                                ║"),console.log("╚═══════════════════════════════════════════════════════════╝"),LMSExtractor.extract().then(e=>{console.log("\n╔═══════════════════════════════════════════════════════════╗"),console.log("║ EXTRACTION COMPLETE                                       ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Additional commands:                                      ║"),console.log("║   LMSExtractor.complete()    - Mark course complete       ║"),console.log("║   LMSExtractor.export()      - Get results as JSON        ║"),console.log("║   LMSExtractor.download()    - Save results to file       ║"),console.log("║   LMSExtractor.windows.getAllWindows() - List all windows ║"),console.log("╚═══════════════════════════════════════════════════════════╝")}).catch(e=>{console.error("[LMS Extractor] Error:",e)})}();