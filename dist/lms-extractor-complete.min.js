!function(){"use strict";const LMSExtractor={results:{questions:[],answers:[],completion:null},extractStoryline(){const e=[];return window.DS&&(console.log("[Extractor] Found window.DS"),this.extractFromDS(window.DS,e)),window.player&&(console.log("[Extractor] Found window.player"),this.extractFromPlayer(window.player,e)),this.scanFrames(e),this.extractFromGlobalData(e),e},extractFromDS(e,t){try{const o=e.getAll?e.getAll():e;for(const[e,s]of Object.entries(o))(e.includes("Quiz")||e.includes("Question")||e.includes("Answer"))&&t.push({source:"DS",key:e,value:s})}catch(e){console.warn("[Extractor] DS extraction error:",e)}},extractFromPlayer(e,t){try{e.GetVar&&["Score","ScorePercent","PassPercent","PassFail"].forEach(o=>{const s=e.GetVar(o);void 0!==s&&t.push({source:"Player",key:o,value:s})})}catch(e){console.warn("[Extractor] Player extraction error:",e)}},scanFrames(e){document.querySelectorAll("iframe").forEach((t,o)=>{try{const s=t.contentDocument||t.contentWindow?.document;s&&s.querySelectorAll('[data-acc-type="radiobutton"], [data-acc-type="checkbox"], [class*="quiz"], [class*="question"]').forEach(t=>{e.push({source:`Frame_${o}`,text:t.textContent?.trim(),element:t.tagName,accType:t.dataset.accType})})}catch(e){}})},extractFromGlobalData(e){window._storylineData&&(console.log("[Extractor] Found _storylineData"),this.parseStorylineData(window._storylineData,e))},async extractTLA(){const e=[],t=this.findTasksJsonUrl();if(t)try{const o=await fetch(t),s=await o.json();this.parseTasksJson(s,e)}catch(e){console.warn("[Extractor] tasks.json fetch error:",e)}return window.ADL?.XAPIWrapper&&console.log("[Extractor] Found ADL xAPI Wrapper"),e},findTasksJsonUrl(){const e=new URLSearchParams(window.location.search).get("contentUrl");if(e)return`/api/assets/tasks.json?contentUrl=${encodeURIComponent(e)}`;const t=performance.getEntriesByType("resource").find(e=>e.name.includes("tasks.json"));return t?.name},parseTasksJson(e,t){if(e?.taskGroups)for(const o of e.taskGroups)for(const e of o.tasks||[])for(const o of e.questions||[])t.push({source:"TLA",id:o.id,prompt:o.prompt,type:o.type,choices:o.choices,correctPattern:o.correctPattern,correct:this.parseCorrectPattern(o.correctPattern,o.type)})},parseCorrectPattern(e,t){if(!e)return null;const o="[,]";switch(t){case"CHOICE":return e.split(o);case"FILL_IN":case"LONG_FILL_IN":if(e.startsWith("{case_matters=")){const t=e.indexOf("}");return{caseMatters:"true"===e.substring(14,t),answers:e.substring(t+1).split(o)}}return{answers:e.split(o)};case"MATCHING":return e.split(o).map(e=>{const[t,o]=e.split("[.]");return{source:t,target:o}});case"SEQUENCING":return e.split(o).map((e,t)=>({position:t+1,item:e}));case"TRUE_FALSE":return"true"===e.toLowerCase();default:return e}},extractSCORM(){const e=[],t=this.findSCORMAPI();if(!t)return console.log("[Extractor] No SCORM API found"),e;console.log("[Extractor] Found SCORM API");try{const o=parseInt(t.GetValue("cmi.interactions._count")||"0");for(let s=0;s<o;s++)e.push({source:"SCORM",id:t.GetValue(`cmi.interactions.${s}.id`),type:t.GetValue(`cmi.interactions.${s}.type`),description:t.GetValue(`cmi.interactions.${s}.description`),correctResponse:t.GetValue(`cmi.interactions.${s}.correct_responses.0.pattern`),learnerResponse:t.GetValue(`cmi.interactions.${s}.learner_response`),result:t.GetValue(`cmi.interactions.${s}.result`)})}catch(e){console.warn("[Extractor] SCORM interaction error:",e)}return e},findSCORMAPI(){let e=window.API;if(e?.LMSGetValue)return{GetValue:t=>e.LMSGetValue(t),SetValue:(t,o)=>e.LMSSetValue(t,o),Commit:()=>e.LMSCommit("")};if(e=window.API_1484_11,e?.GetValue)return e;let t=window;for(let e=0;e<10&&t.parent&&t.parent!==t;e++){if(t=t.parent,t.API?.LMSGetValue)return{GetValue:e=>t.API.LMSGetValue(e),SetValue:(e,o)=>t.API.LMSSetValue(e,o),Commit:()=>t.API.LMSCommit("")};if(t.API_1484_11?.GetValue)return t.API_1484_11}return null},completeSCORM(e=100){const t=this.findSCORMAPI();if(!t)return console.error("[Completion] No SCORM API found"),!1;try{return t.SetValue("cmi.score.raw",String(e)),t.SetValue("cmi.score.scaled",String(e/100)),t.SetValue("cmi.score.min","0"),t.SetValue("cmi.score.max","100"),t.SetValue("cmi.success_status",e>=70?"passed":"failed"),t.SetValue("cmi.completion_status","completed"),t.Commit(),console.log(`[Completion] SCORM completion set: score=${e}, status=completed`),!0}catch(o){try{return t.SetValue("cmi.core.score.raw",String(e)),t.SetValue("cmi.core.lesson_status",e>=70?"passed":"completed"),t.Commit(),console.log("[Completion] SCORM 1.2 completion set"),!0}catch(e){return console.error("[Completion] SCORM completion failed:",e),!1}}},async completeTLA(e,t){if(!e){const t=window.location.href.match(/sessions?\/([a-z]{2}-[0-9a-f-]+)/i);e=t?.[1]}if(t||(t=new URLSearchParams(window.location.search).get("contentUrl")),!e)return console.error("[Completion] No session ID found"),!1;try{let o=null;if(t){const e=await fetch(`/api/assets/tasks.json?contentUrl=${encodeURIComponent(t)}`);e.ok&&(o=await e.json())}const s={answers:{},viewedTasks:[],viewedTaskGroups:[],completedTasks:[],completedTaskGroups:[],questionResults:{}};if(o?.taskGroups){console.log(`[Completion] Iterating through ${o.taskGroups.length} task groups...`);for(const e of o.taskGroups){const t=e.id||e.slug;s.viewedTaskGroups.push(t),console.log(`[Completion]   Group: ${t}`);for(const t of e.tasks||[]){const e=t.id||t.slug;s.viewedTasks.push(e),console.log(`[Completion]     Task: ${e}`);for(const e of t.questions||[]){const t=e.id,o=this.generateTLAAnswer(e);s.answers[t]=o,s.questionResults[t]={answered:!0,correct:!0,response:o,attempts:1},console.log(`[Completion]       Question: ${t} ✓`)}s.completedTasks.push(e)}s.completedTaskGroups.push(t)}}let r={};try{const t=await fetch(`/api/sessions/${e}/lrs/state`);t.ok&&(r=await t.json()||{})}catch(e){}const n={...r,...s,answers:{...r.answers,...s.answers},viewedTasks:[...new Set([...r.viewedTasks||[],...s.viewedTasks])],viewedTaskGroups:[...new Set([...r.viewedTaskGroups||[],...s.viewedTaskGroups])],completedTasks:[...new Set([...r.completedTasks||[],...s.completedTasks])],completedTaskGroups:[...new Set([...r.completedTaskGroups||[],...s.completedTaskGroups])],questionResults:{...r.questionResults,...s.questionResults}};if(await fetch(`/api/sessions/${e}/lrs/state`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),console.log(`[Completion] LRS state updated with ${Object.keys(s.answers).length} answers`),(await fetch(`/api/sessions/${e}/score`,{method:"POST"})).ok)return console.log(`[Completion] TLA score submitted for session ${e}`),!0}catch(e){console.error("[Completion] TLA completion failed:",e)}return!1},generateTLAAnswer(e){const t=e.correctPattern,o=e.type,s="[,]";if(!t)return"";switch(o){case"CHOICE":return t.split(s);case"FILL_IN":case"LONG_FILL_IN":if(t.startsWith("{case_matters=")){const e=t.indexOf("}");return t.substring(e+1).split(s)[0]}return t.split(s)[0];case"MATCHING":case"SEQUENCING":default:return t;case"TRUE_FALSE":return"true"===t.toLowerCase()}},async extract(){console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Starting extraction..."),console.log("═══════════════════════════════════════════════════");const e=[];return e.push(...this.extractStoryline()),e.push(...await this.extractTLA()),e.push(...this.extractSCORM()),this.results.questions=e,console.log(`[LMS Extractor] Found ${e.length} items`),console.table(e),e},getCorrectAnswers(){return this.results.questions.filter(e=>e.correct||e.correctResponse||e.correctPattern)},async complete(e=100){return console.log("═══════════════════════════════════════════════════"),console.log("[LMS Extractor] Attempting completion..."),console.log("═══════════════════════════════════════════════════"),this.completeSCORM(e)?(this.results.completion="SCORM",!0):await this.completeTLA()?(this.results.completion="TLA",!0):(console.warn("[LMS Extractor] Could not complete course automatically"),!1)},export(e="json"){const t={url:window.location.href,timestamp:(new Date).toISOString(),questions:this.results.questions,correctAnswers:this.getCorrectAnswers()};if("json"===e)return JSON.stringify(t,null,2);if("text"===e){let e="LMS Extraction Results\n";return e+=`URL: ${t.url}\n`,e+=`Time: ${t.timestamp}\n\n`,e+="=== QUESTIONS & ANSWERS ===\n\n",t.questions.forEach((t,o)=>{e+=`Q${o+1}: ${t.prompt||t.description||t.text||"N/A"}\n`,e+=`Type: ${t.type||"unknown"}\n`,t.correct&&(e+=`Correct: ${JSON.stringify(t.correct)}\n`),t.correctPattern&&(e+=`Pattern: ${t.correctPattern}\n`),t.correctResponse&&(e+=`Response: ${t.correctResponse}\n`),e+="\n"}),e}return t},download(e="json"){const t=this.export(e),o=new Blob([t],{type:"json"===e?"application/json":"text/plain"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`lms_extraction_${Date.now()}.${"json"===e?"json":"txt"}`,s.click()}};window.LMSExtractor=LMSExtractor,console.log("╔═══════════════════════════════════════════════════════════╗"),console.log("║           LMS EXTRACTOR & COMPLETION TOOL                 ║"),console.log("╠═══════════════════════════════════════════════════════════╣"),console.log("║ Commands:                                                 ║"),console.log("║   LMSExtractor.extract()     - Extract Q&A               ║"),console.log("║   LMSExtractor.complete()    - Mark course complete      ║"),console.log("║   LMSExtractor.export()      - Get results as JSON       ║"),console.log("║   LMSExtractor.download()    - Save results to file      ║"),console.log("╚═══════════════════════════════════════════════════════════╝")}();