!function(){"use strict";const e={patterns:{storylineBase:/(.+?)\/html5\//,storylineContent:/\/story_content\//,dataJs:/\/data\/js\//,tasksJson:/tasks\.json/,sessionId:/sessions?\/([a-z]{2}-[0-9a-f-]+)/i},endpoints:{tasksJson:e=>`/api/assets/tasks.json?contentUrl=${encodeURIComponent(e)}`,lrsState:e=>`/api/sessions/${e}/lrs/state`,score:e=>`/api/sessions/${e}/score`},delimiters:{choice:"[,]",match:"[.]",casePrefix:"{case_matters="},correctStates:["_Review","_Selected_Review","Correct","Right","True","Selected_Correct","Drop_Correct","Drag_Correct"],answerTypes:["checkbox","radiobutton","button","hotspot","dragitem","dropzone","droptarget","textentry"],excludeNav:["continue","next","back","previous","submit","exit","close","menu","home","restart","replay","review"],quizVars:["Results.ScorePoints","Results.ScorePercent","Results.PassPercent","Results.PassPoints","Score","ScorePercent","PassFail","Complete"],playerVars:["Progress","Complete","CurrentSlide","SlideNumber","TotalSlides"],maxParentDepth:20,maxOpenerDepth:10,maxQuestionProbe:50},t={detectContext(){const e={isPopup:!!window.opener,isIframe:window!==window.top,isTopLevel:window===window.top&&!window.opener,hasOpener:!!window.opener,openerAccessible:!1,parentAccessible:!1,topAccessible:!1,windowName:window.name||"(unnamed)",depth:0};if(window.opener)try{window.opener.location.href,e.openerAccessible=!0}catch(t){e.openerAccessible=!1}if(window.parent&&window.parent!==window)try{window.parent.location.href,e.parentAccessible=!0}catch(t){e.parentAccessible=!1}if(window.top&&window.top!==window)try{window.top.location.href,e.topAccessible=!0}catch(t){e.topAccessible=!1}let t=window;for(;t!==t.parent;){e.depth++;try{t=t.parent}catch(e){break}if(e.depth>20)break}return e},getAllWindows(){const e=new Map,t=new WeakSet,s=(s,r)=>{if(s&&!t.has(s)){t.add(s);try{const t=s.location.href;e.has(t)||e.set(t,{window:s,source:r})}catch(e){}}};s(window,"current");let r=window;for(let e=0;e<20&&r;e++){s(r,`parent_${e}`);try{if(r.parent===r)break;r=r.parent}catch(e){break}}let o=window.opener;for(let e=0;e<10&&o;e++){s(o,`opener_${e}`);let t=o;for(let r=0;r<10&&t;r++){s(t,`opener_${e}_parent_${r}`);try{if(t.parent===t)break;t=t.parent}catch(e){break}}try{o=o.opener}catch(e){break}}for(const{window:s}of e.values())this.collectFrames(s,e,t);return e},collectFrames(e,t,s){try{e.document.querySelectorAll("iframe, frame").forEach((e,r)=>{try{const o=e.contentWindow;if(o&&!s.has(o)){s.add(o);try{const n=o.location.href;t.has(n)||t.set(n,{window:o,source:`frame_${r}`,frameElement:e}),this.collectFrames(o,t,s)}catch(e){}}}catch(e){}})}catch(e){}},findSCORMAPIGlobal(){const e=this.getAllWindows();for(const[t,{window:s,source:r}]of e)try{if(s.API_1484_11?.GetValue)return{api:s.API_1484_11,version:"2004",window:s,source:r};if(s.API?.LMSGetValue)return{api:{GetValue:e=>s.API.LMSGetValue(e),SetValue:(e,t)=>s.API.LMSSetValue(e,t),Commit:()=>s.API.LMSCommit("")},version:"1.2",window:s,source:r}}catch(e){}return null},findStorylineGlobal(){const e=this.getAllWindows(),t={DS:null,player:null};for(const[s,{window:r,source:o}]of e)try{r.DS?.GetVar&&!t.DS&&(t.DS={data:r.DS,window:r,source:o}),r.player?.GetVar&&!t.player&&(t.player={data:r.player,window:r,source:o})}catch(e){}return t},findTLAGlobal(){const e=this.getAllWindows(),t={ADL:null};for(const[s,{window:r,source:o}]of e)try{r.ADL?.XAPIWrapper&&!t.ADL&&(t.ADL={data:r.ADL,window:r,source:o})}catch(e){}return t},scanAllFramesForQuizElements(){const e=this.getAllWindows(),t=[],s=['[data-acc-type="radiobutton"]','[data-acc-type="checkbox"]','[data-acc-type="button"]','[class*="quiz"]','[class*="question"]','[class*="answer"]','[role="radio"]','[role="checkbox"]','input[type="radio"]','input[type="checkbox"]'].join(", ");for(const[r,{window:o,source:n}]of e)try{o.document.querySelectorAll(s).forEach(e=>{t.push({source:n,url:r,text:e.textContent?.trim()?.substring(0,200),tagName:e.tagName,accType:e.dataset?.accType,role:e.getAttribute("role"),type:e.type})})}catch(e){}return t}},LMSExtractor={results:{questions:[],answers:[],completion:null,context:null},windowManager:t,extractStoryline(){const e=[],s=t.findStorylineGlobal();return s.DS&&this.extractFromDS(s.DS.data,e),s.player&&this.extractFromPlayer(s.player.data,e),t.scanAllFramesForQuizElements().forEach(t=>{t.text?.length>0&&e.push({source:"DOM",text:t.text,accType:t.accType||t.role||t.type})}),e},extractFromDS(t,s){if("function"==typeof t.GetVar){e.quizVars.forEach(e=>{try{const r=t.GetVar(e);null!=r&&""!==r&&s.push({source:"DS",key:e,value:r})}catch(e){}});for(let r=1;r<=e.maxQuestionProbe;r++)["Answer","Correct","Response","Points","Selected"].forEach(e=>{try{const o=t.GetVar(`Q${r}_${e}`);null!=o&&""!==o&&s.push({source:"DS",key:`Q${r}_${e}`,value:o})}catch(e){}})}},extractFromPlayer(t,s){if("function"!=typeof t.GetVar)return;[...e.quizVars,...e.playerVars].forEach(e=>{try{const r=t.GetVar(e);null!=r&&""!==r&&s.push({source:"Player",key:e,value:r})}catch(e){}});const r=t._variables||t.variables;r&&"object"==typeof r&&Object.entries(r).forEach(([e,t])=>{"function"!=typeof t&&s.push({source:"Player_Internal",key:e,value:t})});for(let r=1;r<=e.maxQuestionProbe;r++)["Answer","Correct","Response","Points","Selected"].forEach(e=>{try{const o=t.GetVar(`Question${r}_${e}`);null!=o&&""!==o&&s.push({source:"Player",key:`Question${r}_${e}`,value:o})}catch(e){}})},parseStorylineData(t,s){const r=t=>!!t?.states?.length&&t.states.some(t=>e.correctStates.some(e=>t.name?.toLowerCase().includes(e.toLowerCase()))),o=(t,n="unknown")=>{if(!t||"object"!=typeof t)return;const a=(e=>e?.textLib?.[0]?.vartext?.blocks?e.textLib[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join("").replace(/\\n/g," ").replace(/\s+/g," ").trim():e?.rawText?.trim()||e?.text?.trim()||e?.title?.trim()||e?.accText?.trim()||"")(t),c=t.accType?.toLowerCase();if(c&&e.answerTypes.includes(c)&&a){const o=a.toLowerCase();if("button"===c&&e.excludeNav.some(e=>o.includes(e)))return;if(s.some(e=>e.text===a&&e.slideId===n))return;s.push({source:"SlideData",slideId:n,text:a,accType:c,correct:r(t)})}for(const e in t)Array.isArray(t[e])?t[e].forEach(e=>o(e,n)):"object"==typeof t[e]&&o(t[e],n)};t.scenes?t.scenes.forEach(e=>(e.slides||[]).forEach(e=>o(e,e.id))):o(t,t.slideId||"slide")},async extractTLA(){const e=[],s=this.findTasksJsonUrl();if(s)try{const t=await fetch(s);t.ok&&this.parseTasksJson(await t.json(),e)}catch(e){}const r=t.findTLAGlobal();return r.ADL&&await this.extractFromXAPI(r.ADL.data,e),e},async extractFromXAPI(e,t){const s=e?.XAPIWrapper;if(!s)return;const r=s.lrs||s.Config||{};if("function"==typeof s.getStatements)try{const e=s.getStatements({verb:"http://adlnet.gov/expapi/verbs/answered",limit:100});(e?.statements||[]).forEach(e=>{t.push({source:"xAPI",id:e.object?.id,verb:e.verb?.display?.["en-US"]||e.verb?.id,response:e.result?.response,success:e.result?.success})})}catch(e){}const o=s.statements||s._statements;if(Array.isArray(o)&&o.forEach(e=>{t.push({source:"xAPI_Cached",id:e.object?.id,response:e.result?.response,success:e.result?.success})}),"function"==typeof s.getState)try{const e=r.activityId||window.location.href.split("?")[0],o=s.getState(e,{stateId:"progress"});o&&t.push({source:"xAPI_State",data:o})}catch(e){}},findTasksJsonUrl(){const t=new URLSearchParams(window.location.search).get("contentUrl");if(t)return e.endpoints.tasksJson(t);const s=performance.getEntriesByType("resource").find(t=>e.patterns.tasksJson.test(t.name));return s?.name},parseTasksJson(e,t){if(e?.taskGroups)for(const s of e.taskGroups)for(const e of s.tasks||[])for(const s of e.questions||[])t.push({source:"TLA",id:s.id,prompt:s.prompt,type:s.type,choices:s.choices,correctPattern:s.correctPattern,correct:this.parseCorrectPattern(s.correctPattern,s.type)})},parseCorrectPattern(t,s){if(!t)return null;const r=e.delimiters;switch(s){case"CHOICE":return t.split(r.choice);case"FILL_IN":case"LONG_FILL_IN":if(t.startsWith(r.casePrefix)){const e=t.indexOf("}");return{caseMatters:"true"===t.substring(r.casePrefix.length,e),answers:t.substring(e+1).split(r.choice)}}return{answers:t.split(r.choice)};case"MATCHING":return t.split(r.choice).map(e=>{const[t,s]=e.split(r.match);return{source:t,target:s}});case"SEQUENCING":return t.split(r.choice).map((e,t)=>({position:t+1,item:e}));case"TRUE_FALSE":return"true"===t.toLowerCase();default:return t}},extractSCORM(){const e=[],s=t.findSCORMAPIGlobal();if(!s)return e;const r=s.api,o=parseInt(r.GetValue("cmi.interactions._count")||"0");for(let t=0;t<o;t++)e.push({source:"SCORM",id:r.GetValue(`cmi.interactions.${t}.id`),type:r.GetValue(`cmi.interactions.${t}.type`),correctResponse:r.GetValue(`cmi.interactions.${t}.correct_responses.0.pattern`),learnerResponse:r.GetValue(`cmi.interactions.${t}.learner_response`),result:r.GetValue(`cmi.interactions.${t}.result`)});return e},completeSCORM(e=100){const s=t.findSCORMAPIGlobal();if(!s)return!1;const r=s.api;try{return"2004"===s.version?(r.SetValue("cmi.score.raw",String(e)),r.SetValue("cmi.score.scaled",String(e/100)),r.SetValue("cmi.score.min","0"),r.SetValue("cmi.score.max","100"),r.SetValue("cmi.success_status",e>=70?"passed":"failed"),r.SetValue("cmi.completion_status","completed")):(r.SetValue("cmi.core.score.raw",String(e)),r.SetValue("cmi.core.lesson_status",e>=70?"passed":"completed")),r.Commit(),!0}catch(e){return console.error("SCORM completion failed:",e),!1}},async completeTLA(t,s){if(!t){const s=window.location.href.match(e.patterns.sessionId);t=s?.[1]}if(s||(s=new URLSearchParams(window.location.search).get("contentUrl")),!t)return!1;try{let r=null;if(s){const t=await fetch(e.endpoints.tasksJson(s));t.ok&&(r=await t.json())}const o={answers:{},viewedTasks:[],viewedTaskGroups:[],completedTasks:[],completedTaskGroups:[],questionResults:{}};if(r?.taskGroups)for(const e of r.taskGroups){const t=e.id||e.slug;o.viewedTaskGroups.push(t);for(const t of e.tasks||[]){const e=t.id||t.slug;o.viewedTasks.push(e);for(const e of t.questions||[]){const t=this.generateTLAAnswer(e);o.answers[e.id]=t,o.questionResults[e.id]={answered:!0,correct:!0,response:t,attempts:1}}o.completedTasks.push(e)}o.completedTaskGroups.push(t)}let n={};try{const s=await fetch(e.endpoints.lrsState(t));s.ok&&(n=await s.json()||{})}catch(e){}const a={...n,...o,answers:{...n.answers,...o.answers},viewedTasks:[...new Set([...n.viewedTasks||[],...o.viewedTasks])],viewedTaskGroups:[...new Set([...n.viewedTaskGroups||[],...o.viewedTaskGroups])],completedTasks:[...new Set([...n.completedTasks||[],...o.completedTasks])],completedTaskGroups:[...new Set([...n.completedTaskGroups||[],...o.completedTaskGroups])],questionResults:{...n.questionResults,...o.questionResults}};return await fetch(e.endpoints.lrsState(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),(await fetch(e.endpoints.score(t),{method:"POST"})).ok}catch(e){return console.error("TLA completion failed:",e),!1}},generateTLAAnswer(t){const s=t.correctPattern;if(!s)return"";const r=e.delimiters;switch(t.type){case"CHOICE":return s.split(r.choice);case"FILL_IN":case"LONG_FILL_IN":if(s.startsWith(r.casePrefix)){const e=s.indexOf("}");return s.substring(e+1).split(r.choice)[0]}return s.split(r.choice)[0];case"MATCHING":case"SEQUENCING":default:return s;case"TRUE_FALSE":return"true"===s.toLowerCase()}},async extract(){this.results.context=t.detectContext();const e=[];return e.push(...this.extractStoryline()),e.push(...await this.extractTLA()),e.push(...this.extractSCORM()),this.results.questions=e,this.results},getCorrectAnswers(){return this.results.questions.filter(e=>e.correct||e.correctResponse||e.correctPattern)},async complete(e=100){return this.completeSCORM(e)?(this.results.completion="SCORM",!0):!!await this.completeTLA()&&(this.results.completion="TLA",!0)},windows:t};window.LMSExtractor=LMSExtractor,LMSExtractor.extract()}();