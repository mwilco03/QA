!function(){"use strict";const e={questionIndicators:["?","select","choose","which","what","identify","match","drag","complete","fill","order","arrange","indicate","determine","find","locate","click","true or false","correct answer","best answer","following","statement","example","describes","represents","demonstrates"],answerAccTypes:["checkbox","radiobutton","button","hotspot","dragitem","dropzone","droptarget","textentry","textinput","input","clickable","selectable"],correctStateIndicators:["_Review","_Selected_Review","Correct","Right","True","Yes","Selected_Correct","Drop_Correct","Drag_Correct","Match_Correct","Answer_Correct"],incorrectStateIndicators:["Incorrect","Wrong","False","No","Drop_Incorrect","Drag_Incorrect"],excludeButtonText:["continue","next","back","previous","submit","exit","close","menu","home","restart","replay","review","try again","start","begin","finish","done","ok","cancel","skip","play","pause","stop","forward","rewind"],xapiVerbs:{ANSWERED:"http://adlnet.gov/expapi/verbs/answered",COMPLETED:"http://adlnet.gov/expapi/verbs/completed",PASSED:"http://adlnet.gov/expapi/verbs/passed",FAILED:"http://adlnet.gov/expapi/verbs/failed"},minAnswerLength:1,minQuestionLength:10,verbose:!1},t=(e,t)=>console.log(`[QAExtractor] ${e}`,t||""),s=(t,s)=>e.verbose&&console.log(`[QAExtractor] ${t}`,s||""),n=(e,t)=>console.error(`[QAExtractor] ${e}`,t||"");function o(e){return e?e.replace(/\\n/g," ").replace(/\s+/g," ").trim():""}function r(t){if(!t||t.length<e.minQuestionLength)return!1;const s=t.toLowerCase();return e.questionIndicators.some(e=>s.includes(e.toLowerCase()))}function c(e){const t=e.match(/globalProvideData\s*\(\s*['"]data['"]\s*,\s*'(.+)'\s*\)/s);if(!t)throw new Error("Could not find globalProvideData in _data.js");let s=t[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r");return JSON.parse(s)}function i(e,t,s){if(e&&"object"==typeof e){if("comparison"===e.kind||"comparison"===e.type){let n=null,o=null;[e.left||e.lhs,e.right||e.rhs].forEach(e=>{if("string"==typeof e&&e.includes("choice_")&&(n=e.match(/choice_[A-Za-z0-9]+/)?.[0]),"string"==typeof e&&e.includes("statement_")){const t=e.match(/statement_[A-Za-z0-9]+/)?.[0],n=s.statements?.find(e=>e.id===t);n?.position&&(o=parseInt(n.position,10))}"number"==typeof e&&(o=e),"string"==typeof e&&/^\d+$/.test(e)&&(o=parseInt(e,10))}),n&&o&&t.set(n,o)}for(const n in e)Array.isArray(e[n])?e[n].forEach(e=>i(e,t,s)):"object"==typeof e[n]&&i(e[n],t,s)}}function a(e){const t=[];if(!e.scenes)return t;for(const s of e.scenes)if(s.slides)for(const e of s.slides){const s=o((e.title||"").replace(/<[^>]*>/g,"")),n=e.interactions||[];for(const o of n){const n=u(o,s,e.id);n&&t.push(n)}if(e.slideLayers)for(const n of e.slideLayers)if(n.objects)for(const o of n.objects)if("sequencectrl"===o.kind&&o.data?.itemlist){const n=l(o,s,e.id);n&&t.push(n)}}return t}function u(e,t,s){const n=e.type?.toLowerCase()||"",r=e.statements?.length>0,c=n.includes("sequence")||n.includes("order")||n.includes("drag")||r,a=c?function(e){const t=new Map;if(e.answers)for(const s of e.answers)"correct"===s.status&&s.eval&&i(s.eval,t,e);if(e.choices&&e.statements)for(const s of e.choices){const n=s.id?.replace(/^choice_/,""),o=e.statements.find(e=>e.id?.includes(n));o?.position&&t.set(s.id,parseInt(o.position,10))}return t}(e):new Map,u=[];if(e.choices)for(const t of e.choices){const e=o(t.text||t.label||"");if(!e)continue;const s={id:t.id,text:e,correct:!1,sequence:null};c&&a.has(t.id)?(s.sequence=a.get(t.id),s.correct=!0):s.correct=!0===t.correct||!0===t.isCorrect,u.push(s)}if(c&&u.sort((e,t)=>(e.sequence||999)-(t.sequence||999)),0===u.length)return null;const l=c?"sequence":e.multiSelect?"multiple-select":"multiple-choice";return{slideId:s,questionId:e.id,question:t||e.prompt||"",questionType:l,answers:u,correctSequence:c?u.filter(e=>e.sequence).map(e=>({position:e.sequence,text:e.text})).sort((e,t)=>e.position-t.position):null,source:"storyline-data"}}function l(e,t,s){const n=[];for(let t=0;t<e.data.itemlist.length;t++){const s=e.data.itemlist[t],r=o(s.textdata?.altText||s.textdata?.lmstext||"");r&&n.push({id:s.itemdata||`item_${t}`,text:r,correct:!0,sequence:t+1})}return 0===n.length?null:{slideId:s,questionId:e.id,question:t,questionType:"sequence",answers:n,correctSequence:n.map(e=>({position:e.sequence,text:e.text})),source:"storyline-data"}}const UnifiedQAExtractor={config:e,extract(i,u="auto",l={}){switch(t(`Extracting Q&A (type: ${u})`),"string"==typeof i&&i.includes("globalProvideData")&&(u="storyline-data-js",i=c(i),u="storyline-data"),"auto"===u&&(u=i.taskGroups?"xapi-manifest":Array.isArray(i)&&i[0]?.verb?"xapi-statements":i.scenes&&i.scenes[0]?.slides?"storyline-data":i.slideLayers||i.objects?"storyline":"raw",t(`Auto-detected type: ${u}`)),u){case"storyline":return function(t,n){const c={slideId:n,question:"",questionType:null,answers:[],source:"storyline"};return function t(n){if(!n||"object"!=typeof n)return;const i=o(function(e){return e.textLib?.[0]?.vartext?.blocks?e.textLib[0].vartext.blocks.flatMap(e=>e.spans?.map(e=>e.text)||[]).join(""):e.rawText?e.rawText:"string"==typeof e.text?e.text:"string"==typeof e.title?e.title:"string"==typeof e.label?e.label:"string"==typeof e.accText?e.accText:""}(n)),a=n.accType;if(function(t){return!!t&&e.answerAccTypes.some(e=>t.toLowerCase()===e.toLowerCase())}(a)&&i&&i.length>=e.minAnswerLength){if("button"===a&&function(t){const s=t.toLowerCase().trim();return e.excludeButtonText.some(e=>s===e||s.includes(e))}(i))return void s(`Skipped nav button: "${i}"`);if(c.answers.some(e=>e.text===i))return void s(`Skipped duplicate: "${i}"`);const t=function(t){if(!t||!Array.isArray(t))return!1;const s=t.some(t=>e.correctStateIndicators.some(e=>t.name?.toLowerCase().includes(e.toLowerCase()))),n=t.every(t=>e.incorrectStateIndicators.some(e=>t.name?.toLowerCase().includes(e.toLowerCase())));return s&&!n}(n.states);c.answers.push({text:i,correct:t,accType:a,states:n.states?.map(e=>e.name)||[]}),c.questionType||("checkbox"===a?c.questionType="multiple-select":"radiobutton"===a?c.questionType="multiple-choice":["dragitem","dropzone","droptarget"].includes(a)?c.questionType="drag-drop":"hotspot"===a?c.questionType="hotspot":["textentry","textinput"].includes(a)?c.questionType="fill-in":"button"===a&&(c.questionType="button-choice"))}"text"!==a&&a||!r(i)||c.answers.some(e=>e.text===i)||(!c.question||i.length>c.question.length)&&(c.question=i);for(const e in n)Array.isArray(n[e])?n[e].forEach(e=>t(e)):"object"==typeof n[e]&&t(n[e])}(t),c}(i,l.slideId||"unknown");case"storyline-data":return a(i);case"xapi-manifest":return function(e){const n=[];if(!e?.taskGroups)return s("No taskGroups found in manifest"),n;for(const t of e.taskGroups)if(t.tasks)for(const e of t.tasks)if(e.questions)for(const t of e.questions)n.push({id:t.id,question:t.prompt||t.question||"",questionType:t.type||"CHOICE",answers:(t.choices||[]).map(e=>({id:e.id,text:e.text||e.label||"",correct:e.correct||!1})),taskId:e.id,taskTitle:e.title,source:"xapi-manifest"});return t(`Extracted ${n.length} questions from manifest`),n}(i);case"xapi-statements":return function(s){const n=new Map;for(const o of s){const s=o.verb?.id,r=o.result;if(s===e.xapiVerbs.ANSWERED&&r){const e=o.object?.id||"",s=e.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$/i),c=s?s[1]:e;n.set(c,{questionId:c,response:r.response,success:r.success,score:r.score,timestamp:o.timestamp,source:"xapi-statement"}),!0===r.success&&t(`Correct answer found for Q ${c.substring(0,8)}...: "${r.response}"`)}}return Array.from(n.values())}(i);case"raw":return function(e){const t=[];return function e(n,c=""){if(n&&"object"==typeof n){if("sequencectrl"===n.kind&&n.data?.itemlist){const e={slideId:c,question:"",questionType:"sequence",answers:[],source:"storyline-raw"};for(const t of n.data.itemlist)t.textdata&&e.answers.push({text:o(t.textdata.altText||t.textdata.lmstext||""),correct:null,id:t.itemdata});e.answers.length>0&&t.push(e)}if("slide"===n.kind&&n.title){const e=n.title.replace(/<[^>]*>/g,"").trim();r(e)&&s(`Potential question slide: ${e.substring(0,50)}...`)}if(n.choices&&Array.isArray(n.choices)){const e={id:n.id,question:n.prompt||n.question||"",questionType:n.type||"choice",answers:n.choices.map(e=>({text:e.text||e.label||"",correct:e.correct||!1,id:e.id})),source:"storyline-raw"};t.push(e)}for(const t in n)Array.isArray(n[t])?n[t].forEach((s,n)=>e(s,`${c}.${t}[${n}]`)):"object"==typeof n[t]&&e(n[t],`${c}.${t}`)}}(e),t}(i);default:return n(`Unknown extraction type: ${u}`),[]}},extractFromDataJS:e=>a(c(e)),merge(...e){const t=new Map,s=e.flat();for(const e of s){const s=e.question||e.id||e.slideId||JSON.stringify(e.answers);if(t.has(s)){const n=t.get(s);if(e.answers&&n.answers){const t=new Set(n.answers.map(e=>e.text));for(const s of e.answers)t.has(s.text)||n.answers.push(s)}}else t.set(s,e)}return Array.from(t.values())},export(e,t="json"){switch(t){case"json":return JSON.stringify(e,null,2);case"text":{let t="=== EXTRACTED Q&A ===\n\n";return e.forEach((e,s)=>{t+=`--- Question ${s+1} [${e.slideId||"N/A"}] ---\n`,t+=`Type: ${e.questionType||"unknown"}\n`,e.question&&(t+=`Q: ${e.question}\n`),e.correctSequence&&e.correctSequence.length>0?(t+="\nCorrect Sequence:\n",e.correctSequence.forEach(e=>{t+=`  ${e.position}. ${e.text}\n`})):e.answers&&(t+="\nAnswers:\n",e.answers.forEach((e,s)=>{const n=e.correct?"[X]":"[ ]",o=e.sequence?` (pos: ${e.sequence})`:"";t+=`  ${s+1}. ${n} ${e.text}${o}\n`})),t+="\n"}),t}case"csv":{let t="SlideID,Question,Answer,Correct,Sequence,Type,Source\n";return e.forEach(e=>{e.answers&&e.answers.forEach(s=>{const n=(e.slideId||"").replace(/"/g,'""'),o=(e.question||"").replace(/"/g,'""'),r=(s.text||"").replace(/"/g,'""'),c=s.sequence||"";t+=`"${n}","${o}","${r}",${s.correct},${c},${e.questionType||""},${e.source||""}\n`})}),t}default:return JSON.stringify(e)}},download(e,s="json",o="qa_export"){if("undefined"==typeof document)return void n("Download only available in browser environment");const r=this.export(e,s),c="csv"===s?"csv":"text"===s?"txt":"json",i=new Blob([r],{type:"csv"===s?"text/csv":"text"===s?"text/plain":"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=`${o}.${c}`,a.click(),t(`Downloaded ${o}.${c}`)},getCorrectAnswers:e=>e.map(e=>e.correctSequence&&e.correctSequence.length>0?{slideId:e.slideId,question:e.question,questionType:e.questionType,correctSequence:e.correctSequence,correctAnswer:e.correctSequence.map(e=>`${e.position}. ${e.text}`).join(" â†’ "),source:e.source}:{...e,answers:(e.answers||[]).filter(e=>e.correct),correctAnswer:(e.answers||[]).filter(e=>e.correct).map(e=>e.text).join(", ")}).filter(e=>e.answers?.length>0||e.correctSequence?.length>0),getStats(e){const t={totalQuestions:e.length,totalAnswers:0,correctAnswers:0,byType:{},bySource:{}};for(const s of e){const e=s.answers||[];t.totalAnswers+=e.length,t.correctAnswers+=e.filter(e=>e.correct).length;const n=s.questionType||"unknown";t.byType[n]=(t.byType[n]||0)+1;const o=s.source||"unknown";t.bySource[o]=(t.bySource[o]||0)+1}return t},setVerbose(t){e.verbose=t}};"undefined"!=typeof window&&(window.UnifiedQAExtractor=UnifiedQAExtractor,t("UnifiedQAExtractor loaded. Use window.UnifiedQAExtractor.extract(data) to extract Q&A")),"undefined"!=typeof module&&module.exports&&(module.exports=UnifiedQAExtractor)}("undefined"!=typeof window?window:global);