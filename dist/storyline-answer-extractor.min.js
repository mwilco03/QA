#!/usr/bin/env node
!function(t){"use strict";function e(t){const e=t.match(/globalProvideData\s*\(\s*['"]data['"]\s*,\s*'(.+)'\s*\)/s);if(!e)throw new Error("Could not find globalProvideData in content");let n=e[1].replace(/\\'/g,"'").replace(/\\\\"/g,'\\"').replace(/\\\\n/g,"\\n").replace(/\\\\t/g,"\\t").replace(/\\\\r/g,"\\r");return JSON.parse(n)}function n(t,e){if(!t||!e)return null;const n=e.replace("choices.","").replace("choice_","");for(const o of t)if((o.id||"").replace("choice_","")===n||o.id===e||o.id===`choice_${n}`)return o.lmstext||o.text||o.label||null;return null}function o(t,e){if(!t||!e)return null;const n=e.replace("statements.","").replace("statement_","");for(const o of t)if((o.id||"").replace("statement_","")===n||o.id===e||o.id===`statement_${n}`)return o.lmstext||o.text||o.position||null;return null}function r(t){const e=[];for(const r of t.answers||[])if("correct"===r.status)for(const s of r.evaluate?.statements||[])if("equals"===s.kind){const o=n(t.choices,s.choiceid);o&&e.push(o)}else if("pair"===s.kind){const r=n(t.choices,s.choiceid),i=o(t.statements,s.statementid);r&&i&&e.push({position:i,text:r})}return e}function s(t,e=null){const n=[];for(const o of t.scenes||[])for(const t of o.slides||[])for(const s of t.interactions||[]){if(e){const t=e.toLowerCase();if(!(s.lmstext||"").toLowerCase().includes(t))continue}const i=r(s);0!==i.length&&n.push({question_id:s.id,question_text:(s.lmstext||"").replace(/\\n/g,"\n").trim(),question_type:s.type||"unknown",choices:(s.choices||[]).map(t=>t.lmstext||t.text||""),correct_answers:i,slide_id:t.id,scene_id:o.id})}return n}function i(t,e=0,n=3){if(e>n)return;const o="  ".repeat(e);for(const[r,s]of Object.entries(t||{})){const t=Array.isArray(s)?"array":typeof s;let a="";a="array"===t?`[${s.length} items]`:"object"===t&&null!==s?"{...}":"string"===t?s.substring(0,50)+(s.length>50?"...":""):String(s),console.log(`${o}${r}: (${t}) ${a}`),"object"===t&&null!==s?i(s,e+1,n):"array"===t&&s.length>0&&"object"==typeof s[0]&&(console.log(`${o}  [0]:`),i(s[0],e+2,n))}}function a(t,e="data"){if(Array.isArray(t))t.forEach((t,n)=>a(t,`${e}[${n}]`));else if(t&&"object"==typeof t){t.interactions&&Array.isArray(t.interactions)&&(console.log(`Found interactions at: ${e}.interactions (${t.interactions.length} items)`),t.interactions[0]&&console.log("  Sample keys:",Object.keys(t.interactions[0]).join(", ")));for(const[n,o]of Object.entries(t))a(o,`${e}.${n}`)}}function c(t,e="data"){if(Array.isArray(t))t.forEach((t,n)=>c(t,`${e}[${n}]`));else if(t&&"object"==typeof t){t.answers&&Array.isArray(t.answers)&&(console.log(`\nAnswers at: ${e}`),t.answers.forEach(t=>{console.log(`  Status: ${t.status}, Points: ${t.points||"N/A"}`),t.evaluate?.statements&&t.evaluate.statements.forEach(t=>{console.log(`    Kind: ${t.kind}`,JSON.stringify(t))})}));for(const[n,o]of Object.entries(t))c(o,`${e}.${n}`)}}const StorylineAnswerExtractor={extract:(t,n=null)=>s(e(t),n),extractFromJSON:(t,e=null)=>s(t,e),async run(){if(console.log("[StorylineAnswerExtractor] Auto-discovering data..."),"undefined"!=typeof window&&window.DS){console.log("[StorylineAnswerExtractor] Found window.DS");const t=s(window.DS);return console.log(`[StorylineAnswerExtractor] Extracted ${t.length} questions`),t}const t=["./html5/data/js/data.js","../html5/data/js/data.js","html5/data/js/data.js","./data.js"];for(const e of t)try{const t=await fetch(e);if(t.ok){const n=await t.text();if(n.includes("globalProvideData")){console.log(`[StorylineAnswerExtractor] Found data at: ${e}`);const t=this.extract(n);return console.log(`[StorylineAnswerExtractor] Extracted ${t.length} questions`),t}}}catch(t){}throw new Error("Could not find Storyline data. Try: StorylineAnswerExtractor.extract(content)")},format(t,e="json"){switch(e.toLowerCase()){case"text":case"txt":return function(t){let e="";return t.forEach((t,n)=>{e+="================================================================================\n",e+=`QUESTION ${n+1}: ${t.question_text.split("\n")[0]}\n`,t.question_text.includes("\n")&&(e+=t.question_text.split("\n").slice(1).join("\n")+"\n"),e+="================================================================================\n",e+=`Type: ${t.question_type}\n`,e+=`ID: ${t.question_id}\n\n`,e+="CHOICES:\n",t.choices.forEach((t,n)=>{e+=`  ${n+1}. ${t}\n`}),e+="\nCORRECT ANSWER",t.correct_answers.length>1&&(e+="S"),e+=":\n",t.correct_answers.some(t=>"object"==typeof t&&t.position)?[...t.correct_answers].sort((t,e)=>parseInt(t.position)-parseInt(e.position)).forEach(t=>{e+=`  Position ${t.position}: ${t.text}\n`}):t.correct_answers.forEach(t=>{e+=`  * ${t}\n`}),e+="\n"}),e}(t);case"csv":return function(t){let e="QuestionID,QuestionText,QuestionType,CorrectAnswers\n";return t.forEach(t=>{const n=t.question_text.replace(/"/g,'""').replace(/\n/g," ");let o;o=t.correct_answers.some(t=>"object"==typeof t&&t.position)?[...t.correct_answers].sort((t,e)=>parseInt(t.position)-parseInt(e.position)).map(t=>`${t.position}:${t.text}`).join(" | "):t.correct_answers.join(" | "),o=o.replace(/"/g,'""'),e+=`"${t.question_id}","${n}","${t.question_type}","${o}"\n`}),e}(t);default:return function(t){return JSON.stringify(t,null,2)}(t)}},getAnswerKey:t=>t.map(t=>{if(t.correct_answers.some(t=>"object"==typeof t&&t.position)){const e=[...t.correct_answers].sort((t,e)=>parseInt(t.position)-parseInt(e.position));return{question:t.question_text.split("\n")[0],type:t.question_type,answer:e.map(t=>`${t.position}. ${t.text}`).join(" -> ")}}return{question:t.question_text.split("\n")[0],type:t.question_type,answer:t.correct_answers.join(", ")}}),parseGlobalProvideData:e,enumerateStructure:i,findInteractions:a,findAnswerPatterns:c,findChoiceText:n,findStatementPosition:o};if("undefined"!=typeof require&&"undefined"!=typeof module&&require.main===module){const t=require("fs"),n=(require("path"),process.argv.slice(2));(0===n.length||n.includes("--help")||n.includes("-h"))&&(console.log('\nStoryline Answer Extractor\n==========================\n\nExtract correct answers from Articulate Storyline exam files.\n\nUsage:\n  node storyline-answer-extractor.js <data.js> [options]\n\nArguments:\n  <data.js>           Path to Storyline data file (contains globalProvideData)\n\nOptions:\n  --search=<term>     Filter questions containing <term>\n  --format=<fmt>      Output format: json (default), text, csv\n  --enumerate         Show data structure (for debugging)\n  --output=<file>     Write output to file\n  -h, --help          Show this help\n\nExamples:\n  node storyline-answer-extractor.js ./html5/data/js/data.js\n  node storyline-answer-extractor.js data.js --format=text\n  node storyline-answer-extractor.js data.js --search="collection plan"\n  node storyline-answer-extractor.js data.js --enumerate\n'),process.exit(0));const o=n.find(t=>!t.startsWith("--")),r=n.find(t=>t.startsWith("--search=")),l=n.find(t=>t.startsWith("--format=")),u=n.find(t=>t.startsWith("--output=")),d=n.includes("--enumerate"),f=r?r.split("=")[1]:null,p=l?l.split("=")[1]:"json",y=u?u.split("=")[1]:null;o||(console.error("Error: Please provide a data file path"),process.exit(1));try{const n=e(t.readFileSync(o,"utf-8"));d&&(console.log("=== DATA STRUCTURE ===\n"),i(n,0,2),console.log("\n=== INTERACTION PATHS ===\n"),a(n),console.log("\n=== ANSWER PATTERNS ==="),c(n),process.exit(0));const r=s(n,f);console.error(`[INFO] Extracted ${r.length} questions`),f&&console.error(`[INFO] Filtered by: "${f}"`);const l=StorylineAnswerExtractor.format(r,p);y?(t.writeFileSync(y,l),console.error(`[INFO] Written to: ${y}`)):console.log(l)}catch(t){console.error(`[ERROR] ${t.message}`),process.exit(1)}}"undefined"!=typeof window&&(window.StorylineAnswerExtractor=StorylineAnswerExtractor,console.log("[StorylineAnswerExtractor] Ready. Use: StorylineAnswerExtractor.run() or .extract(content)")),"undefined"!=typeof module&&module.exports&&(module.exports=StorylineAnswerExtractor),void 0!==t&&(t.StorylineAnswerExtractor=StorylineAnswerExtractor)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:this);